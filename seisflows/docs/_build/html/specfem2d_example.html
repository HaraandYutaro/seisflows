<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Specfem2D workstation example &mdash; SeisFlows3  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="_static/sf3_globe_alpha.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extending SeisFlows3" href="extending.html" />
    <link rel="prev" title="Working Directory Structure" href="working_directory.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> SeisFlows3
            <img src="_static/sf3_globe_alpha_wide.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="start_here.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="citeme.html">Cite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Structure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="command_line_tool.html">Commmand Line Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter_file.html">Parameter File</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_directory.html">Working Directory Structure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Specfem2D workstation example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#option-1-automated-run">Option 1: Automated run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#option-2-manual-run">Option 2: Manual run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-specfem2d">1. Setup SPECFEM2D</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-download-and-compile-codebase-optional">1a. Download and compile codebase (optional)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-create-a-separate-specfem2d-working-directory">1b. Create a separate SPECFEM2D working directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-generate-initial-and-target-models">1c. Generate initial and target models</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#initialize-seisflows3-sf3">2. Initialize SeisFlows3 (SF3)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-sf3-working-directory-and-parameter-file">2a. SF3 working directory and parameter file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-initialize-sf3-working-state">2b. Initialize SF3 working state</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-seisflows3">3. Run SeisFlows3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-forward-simulations">3a. Forward simulations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-adjoint-simulations">3b. Adjoint simulations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-line-search-and-model-update">3c. Line search and model update</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#conclusions">4. Conclusions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Extending SeisFlows3</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_dev_plan.html">Code Development Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SeisFlows3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Specfem2D workstation example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/specfem2d_example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="specfem2d-workstation-example">
<h1>Specfem2D workstation example<a class="headerlink" href="#specfem2d-workstation-example" title="Permalink to this headline"></a></h1>
<p>To demonstrate the inversion capabilities of SeisFlows3, we will run a
<strong>Specfem2D synthetic-synthetic example</strong> on a <strong>local machine</strong> (Linux
workstation running CentOS 7). Many of the setup steps here will likely
be unique to our OS and workstation, but hopefully they may serve as
templates for new Users wanting to explore SeisFlows3.</p>
<p>The numerical solver we will use is:
<a class="reference external" href="https://geodynamics.org/cig/software/specfem2d/">SPECFEM2D</a>. We’ll
also be working in our <code class="docutils literal notranslate"><span class="pre">seisflows3</span></code>
<a class="reference external" href="https://docs.conda.io/en/latest/">Conda</a> environment, see the
installation documentation page for instructions on how to install and
activate the required Conda environment.</p>
<hr class="docutils" />
<div class="section" id="option-1-automated-run">
<h2>Option 1: Automated run<a class="headerlink" href="#option-1-automated-run" title="Permalink to this headline"></a></h2>
<p>We have set up this example to run using a single command line argument.
The following command will run an example script which will (1) download
and compile SPECFEM2D, (2) setup a SPECFEM2D working directory to
generate initial and target models, and (3) Run a SeisFlows3 inversion.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This example attempts to automatically download and compile SPECFEM2D. This step may fail if you are software required by SPECFEM2D, there are issues with the SPECFEM2D repository itself, or the configuration and compiling steps fail. If you run any issues, it is recommended that you manually install and compile SPECFEM2D, and directly provide its path to this example problem when prompted.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seisflows</span> <span class="n">examples</span> <span class="n">run</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Run</span> <span class="n">example</span><span class="p">:</span> <span class="n">ex1_specfem2d_workstation_inversion</span>

                                    <span class="o">@@@@@@@@@@</span>
                               <span class="o">.@@@@.</span>    <span class="o">.%&amp;</span><span class="p">(</span>  <span class="o">%@.</span>
                            <span class="o">@@@@</span>   <span class="o">@@@@</span>   <span class="o">&amp;@@@@@@</span> <span class="p">,</span><span class="o">%@</span>
                         <span class="o">@@@@</span>   <span class="o">@@@</span><span class="p">,</span>  <span class="o">/@@</span>              <span class="o">@</span>
                        <span class="o">@@@</span>   <span class="o">@@@@</span>   <span class="o">@@@</span>              <span class="o">@</span>
                      <span class="o">@@@@</span>   <span class="o">@@@@</span>   <span class="o">@@@</span>                <span class="o">@</span>  <span class="o">@</span>
                      <span class="o">@@@</span>   <span class="o">@@@@</span>   <span class="p">,</span><span class="o">@@@</span>                <span class="o">@</span> <span class="o">@</span>
                     <span class="o">@@@@</span>   <span class="o">@@@@</span>    <span class="o">@@@@</span>              <span class="o">@@</span> <span class="o">@</span> <span class="o">@</span>
                     <span class="o">@@@@</span>   <span class="o">@@@@@</span>    <span class="o">@@@@@</span>          <span class="o">@@@</span> <span class="o">@@</span> <span class="o">@</span>
                     <span class="o">@@@@</span>    <span class="o">@@@@@</span>     <span class="o">@@@@@@@@@@@@@@</span>  <span class="o">@@</span>  <span class="o">@</span>
                      <span class="o">@@@@</span>    <span class="o">@@@@@@</span>        <span class="o">@@@&amp;</span>     <span class="o">@@@</span>  <span class="o">@</span>
                      <span class="o">@@@@@</span>     <span class="o">@@@@@@@@</span>         <span class="o">%@@@@</span><span class="c1">#  @@</span>
                        <span class="o">@@@@</span><span class="c1">#      @@@@@@@@@@@@@@@@@   @@</span>
                         <span class="o">&amp;@@@@@</span>          <span class="o">@@@@</span><span class="p">(</span>       <span class="o">@@&amp;</span>
                            <span class="o">@@@@@@@</span>             <span class="o">/@@@@</span>
                                <span class="o">@@@@@@@@@@@@@@@@@</span>
                                    <span class="o">@@@@@@@@@@</span>

<span class="o">================================================================================</span>
                              <span class="n">SEISFLOWS3</span> <span class="n">EXAMPLE</span> <span class="mi">1</span>
                              <span class="o">////////////////////</span>
<span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="p">[</span><span class="n">SPECFEM2D</span><span class="p">]</span> <span class="p">[</span><span class="n">WORKSTATION</span><span class="p">]</span> <span class="n">example</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">run</span> <span class="mi">2</span> <span class="n">iterations</span> <span class="n">of</span> <span class="n">an</span>
<span class="n">inversion</span> <span class="n">to</span> <span class="n">assess</span> <span class="n">misfit</span> <span class="n">between</span> <span class="n">two</span> <span class="n">homogeneous</span> <span class="n">halfspace</span> <span class="n">models</span> <span class="k">with</span>
<span class="n">slightly</span> <span class="n">different</span> <span class="n">velocities</span><span class="p">,</span> <span class="mi">3</span> <span class="n">sources</span> <span class="ow">and</span> <span class="mi">1</span> <span class="n">receiver</span><span class="o">.</span> <span class="n">The</span> <span class="n">tasks</span> <span class="n">involved</span>
<span class="n">include</span><span class="p">:</span>

<span class="mf">1.</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">Download</span><span class="p">,</span> <span class="n">configure</span><span class="p">,</span> <span class="nb">compile</span> <span class="n">SPECFEM2D</span>
<span class="mf">2.</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">a</span> <span class="n">SPECFEM2D</span> <span class="n">working</span> <span class="n">directory</span>
<span class="mf">3.</span> <span class="n">Generate</span> <span class="n">starting</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">Tape2007</span> <span class="n">example</span>
<span class="mf">4.</span> <span class="n">Generate</span> <span class="n">target</span> <span class="n">model</span> <span class="n">w</span><span class="o">/</span> <span class="n">perturbed</span> <span class="n">starting</span> <span class="n">model</span>
<span class="mf">5.</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">a</span> <span class="n">SeisFlows3</span> <span class="n">working</span> <span class="n">directory</span>
<span class="mf">6.</span> <span class="n">Run</span> <span class="mi">2</span> <span class="n">iterations</span> <span class="n">of</span> <span class="n">an</span> <span class="n">inversion</span> <span class="n">workflow</span>
<span class="o">================================================================================</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">have</span> <span class="n">already</span> <span class="n">downloaded</span> <span class="n">SPECMFE2D</span><span class="p">,</span> <span class="n">please</span> <span class="nb">input</span> <span class="n">its</span> <span class="n">path</span> <span class="n">here</span><span class="o">.</span> <span class="n">If</span> <span class="n">blank</span><span class="p">,</span>
<span class="n">this</span> <span class="n">example</span> <span class="n">will</span> <span class="n">pull</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">version</span> <span class="kn">from</span> <span class="nn">GitHub</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">configure</span>
<span class="ow">and</span> <span class="n">make</span> <span class="n">the</span> <span class="n">binaries</span><span class="p">:</span> <span class="o">&gt;</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="option-2-manual-run">
<h2>Option 2: Manual run<a class="headerlink" href="#option-2-manual-run" title="Permalink to this headline"></a></h2>
<p>The notebook below details a walkthrough of the automated run shown
above. This is meant for those who want to understand what is going on
under the hood. You are welcome to follow along on your workstation. The
following Table of Contents outlines the steps we will take in this
tutorial:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Navigation links will not work outside of Jupyter. Please use the navigation bar to the left.</p>
</div>
<ol class="arabic simple">
<li><p><a class="reference external" href="#1.-Setup-SPECFEM2D">Setup SPECFEM2D</a></p>
<ol class="loweralpha simple">
<li><p><a class="reference external" href="#1a.-Download-and-compile-codebase*">Download and compile
codebase</a></p></li>
<li><p><a class="reference external" href="#1b.-Create-a-separate-SPECFEM2D-working-directory">Create a separate SPECFEM2D working
directory</a></p></li>
<li><p><a class="reference external" href="#1c.-Generate-initial-and-target-models">Generate initial and target
models</a></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#2.-Initialize-SeisFlows3-(SF3)">Initialize SeisFlows3 (SF3)</a></p>
<ol class="loweralpha simple">
<li><p><a class="reference external" href="#2a.-SF3-working-directory-and-parameter-file">SF3 working directory and parameter
file</a></p></li>
<li><p><a class="reference external" href="#2b.-Initialize-SF3-working-state">Initialize SF3 working
state</a></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#2.-Run-SeisFlows3">Run SeisFlows3</a></p>
<ol class="loweralpha simple">
<li><p><a class="reference external" href="#3a.-Forward-simulations">Forward simulations</a></p></li>
<li><p><a class="reference external" href="#3b.-Exploring-the-SF3-directory-structure">Exploring the SF3 directory
structure</a></p></li>
<li><p><a class="reference external" href="#3c.-Adjoint-simulations">Adjoint simulations</a></p></li>
<li><p><a class="reference external" href="#3d.-Line-search-and-model-update">Line search and model
update</a></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#4.-Conclusions">Conclusions</a></p></li>
</ol>
<div class="section" id="setup-specfem2d">
<h3>1. Setup SPECFEM2D<a class="headerlink" href="#setup-specfem2d" title="Permalink to this headline"></a></h3>
<div class="section" id="a-download-and-compile-codebase-optional">
<h4>1a. Download and compile codebase (optional)<a class="headerlink" href="#a-download-and-compile-codebase-optional" title="Permalink to this headline"></a></h4>
<blockquote>
<div><p><strong>NOTE</strong>: If you have already downloaded and compiled SPECFEM2D, you
can skip most of this subsection (1a). However you will need to edit
the first two paths in the following cell (WORKDIR and
SPECFEM2D_ORIGINAL), and execute the path structure defined in the
cell.</p>
</div></blockquote>
<p>First we’ll download and compile SPECFEM2D to generate the binaries
necessary to run our simulations. We will then populate a new SPECFEM2D
working directory that will be used by SeisFlows3. We’ll use to Python
OS module to do our filesystem processes just to keep everything in
Python, but this can easily be accomplished in bash.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># vvv USER MUST EDIT THE FOLLOWING PATHS vvv</span>
<span class="n">WORKDIR</span> <span class="o">=</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example&quot;</span>
<span class="n">SPECFEM2D</span> <span class="o">=</span> <span class="s2">&quot;/home/bchow/REPOSITORIES/specfem2d&quot;</span>
<span class="c1"># where WORKDIR: points to your own working directory</span>
<span class="c1"># and SPECFEM2D: points to an existing specfem2D repository if available (if not set as &#39;&#39;)</span>
<span class="c1"># ^^^ USER MUST EDIT THE FOLLOWING PATHS ^^^</span>
<span class="c1"># ======================================================================================================</span>

<span class="c1"># Distribute the necessary file structure of the SPECFEM2D repository that we will downloaded/reference</span>
<span class="n">SPECFEM2D_ORIGINAL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">,</span> <span class="s2">&quot;specfem2d&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_BIN_ORIGINAL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_ORIGINAL</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_DATA_ORIGINAL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_ORIGINAL</span><span class="p">,</span> <span class="s2">&quot;DATA&quot;</span><span class="p">)</span>
<span class="n">TAPE_2007_EXAMPLE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_ORIGINAL</span><span class="p">,</span> <span class="s2">&quot;EXAMPLES&quot;</span><span class="p">,</span> <span class="s2">&quot;Tape2007&quot;</span><span class="p">)</span>

<span class="c1"># The SPECFEM2D working directory that we will create separate from the downloaded repo</span>
<span class="n">SPECFEM2D_WORKDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">,</span> <span class="s2">&quot;specfem2d_workdir&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_BIN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_DATA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">,</span> <span class="s2">&quot;DATA&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_OUTPUT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">,</span> <span class="s2">&quot;OUTPUT_FILES&quot;</span><span class="p">)</span>

<span class="c1"># Pre-defined locations of velocity models we will generate using the solver</span>
<span class="n">SPECFEM2D_MODEL_INIT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">,</span> <span class="s2">&quot;OUTPUT_FILES_INIT&quot;</span><span class="p">)</span>
<span class="n">SPECFEM2D_MODEL_TRUE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">,</span> <span class="s2">&quot;OUTPUT_FILES_TRUE&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download SPECFEM2D from GitHub, devel branch for latest codebase OR symlink from existing repo</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;specfem2d&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SPECFEM2D repository already found, you may skip this subsection&quot;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SPECFEM2D</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Existing SPECMFE2D respository found, symlinking to working directory&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">SPECFEM2D</span><span class="p">,</span> <span class="s2">&quot;./specfem2d&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cloning respository from GitHub&quot;</span><span class="p">)</span>
    <span class="o">!</span> git clone --recursive --branch devel https://github.com/geodynamics/specfem2d.git
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Existing</span> <span class="n">SPECMFE2D</span> <span class="n">respository</span> <span class="n">found</span><span class="p">,</span> <span class="n">symlinking</span> <span class="n">to</span> <span class="n">working</span> <span class="n">directory</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile SPECFEM2D to generate the Makefile</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_ORIGINAL</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./config.log&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;./configure&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run make to generate SPECFEM2D binaries</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;make all&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check out the binary files that have been created</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_ORIGINAL</span><span class="p">)</span>
<span class="o">!</span> pwd
<span class="o">!</span> ls bin/
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">REPOSITORIES</span><span class="o">/</span><span class="n">specfem2d</span>
<span class="n">xadj_seismogram</span>                   <span class="n">xconvolve_source_timefunction</span>  <span class="n">xspecfem2D</span>
<span class="n">xcheck_quality_external_mesh</span>  <span class="n">xmeshfem2D</span>                 <span class="n">xsum_kernels</span>
<span class="n">xcombine_sem</span>                      <span class="n">xsmooth_sem</span>
</pre></div>
</div>
</div>
<div class="section" id="b-create-a-separate-specfem2d-working-directory">
<h4>1b. Create a separate SPECFEM2D working directory<a class="headerlink" href="#b-create-a-separate-specfem2d-working-directory" title="Permalink to this headline"></a></h4>
<p>Next we’ll create a new SPECFEM2D working directory, separate from the
original repository. The intent here is to isolate the original
SPECFEM2D repository from our working state, to protect it from things
like accidental file deletions or manipulations. This is not a mandatory
step for using SeisFlows3, but it helps keep file structure clean in the
long run, and is the SeisFlows3 dev team’s preferred method of using
SPECFEM.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All SPECFEM2D/3D/3D_GLOBE need to run successfully are the bin/, DATA/, and OUTPUT_FILES/ directories. Everything else in the repository is not mandatory for running binaries.</p>
</div>
<p>In this tutorial we will be using the <a class="reference external" href="https://github.com/geodynamics/specfem2d/tree/devel/EXAMPLES/Tape2007">Tape2007 example
problem</a>
to define our <strong>DATA/</strong> directory (last tested 3/9/22, cf893667).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incase we&#39;ve run this docs page before, delete the working directory before remaking</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>

<span class="c1"># Copy the binary files incase we update the source code. These can also be symlinked.</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">SPECFEM2D_BIN_ORIGINAL</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>

<span class="c1"># Copy the DATA/ directory because we will be making edits here frequently and it&#39;s useful to</span>
<span class="c1"># retain the original files for reference. We will be running one of the example problems: Tape2007</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TAPE_2007_EXAMPLE</span><span class="p">,</span> <span class="s2">&quot;DATA&quot;</span><span class="p">),</span> <span class="s2">&quot;DATA&quot;</span><span class="p">)</span>

<span class="o">!</span> pwd
<span class="o">!</span> ls
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">specfem2d_workdir</span>
<span class="nb">bin</span>  <span class="n">DATA</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the Tape2007 example to make sure SPECFEM2D is working as expected</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">TAPE_2007_EXAMPLE</span><span class="p">)</span>
<span class="o">!</span> ./run_this_example.sh &gt; output_log.txt

<span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;OUTPUT_FILES/forward_image000004800.jpg&quot;</span><span class="p">)),</span> \
    <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Example did not run, the remainder of this docs page will likely not work.&quot;</span>
     <span class="sa">f</span><span class="s2">&quot;Please check the following directory: </span><span class="si">{</span><span class="n">TAPE_2007_EXAMPLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="o">!</span> tail output_log.txt
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">-------------------------------------------------------------------------------</span>
 <span class="o">-------------------------------------------------------------------------------</span>
 <span class="n">D</span> <span class="n">a</span> <span class="n">t</span> <span class="n">e</span> <span class="p">:</span> <span class="mi">29</span> <span class="o">-</span> <span class="mi">04</span> <span class="o">-</span> <span class="mi">2022</span>                                 <span class="n">T</span> <span class="n">i</span> <span class="n">m</span> <span class="n">e</span>  <span class="p">:</span> <span class="mi">12</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">51</span>
 <span class="o">-------------------------------------------------------------------------------</span>
 <span class="o">-------------------------------------------------------------------------------</span>

<span class="n">see</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">directory</span><span class="p">:</span> <span class="n">OUTPUT_FILES</span><span class="o">/</span>

<span class="n">done</span>
<span class="n">Fri</span> <span class="n">Apr</span> <span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">51</span> <span class="n">AKDT</span> <span class="mi">2022</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Now we need to manually set up our SPECFEM2D working directory. As
mentioned in the previous cell, the only required elements of this
working directory are the following (these files will form the basis for
how SeisFlows3 operates within the SPECFEM2D framework):</p>
<ol class="arabic simple">
<li><p><strong>bin/</strong> directory containing SPECFEM2D binaries</p></li>
<li><p><strong>DATA/</strong> directory containing SOURCE and STATION files, as well as a
SPECFEM2D Par_file</p></li>
<li><p>__OUTPUT_FILES/proc??????_*.bin__ files which define the starting
(and target) models</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This file structure is the same for all versions of SPECFEM (2D/3D/3D_GLOBE)</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First we will set the correct SOURCE and STATION files.</span>
<span class="c1"># This is the same task as shown in ./run_this_example.sh</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_DATA</span><span class="p">)</span>

<span class="c1"># Symlink source 001 as our main source</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;SOURCE&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;SOURCE&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="s2">&quot;SOURCE_001&quot;</span><span class="p">,</span> <span class="s2">&quot;SOURCE&quot;</span><span class="p">)</span>

<span class="c1"># Copy the correct Par_file so that edits do not affect the original file</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;Par_file&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Par_file&quot;</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;Par_file_Tape2007_onerec&quot;</span><span class="p">,</span> <span class="s2">&quot;Par_file&quot;</span><span class="p">)</span>

<span class="o">!</span> ls
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interfaces_Tape2007</span><span class="o">.</span><span class="n">dat</span>                  <span class="n">SOURCE_003</span>  <span class="n">SOURCE_012</span>  <span class="n">SOURCE_021</span>
<span class="n">model_velocity</span><span class="o">.</span><span class="n">dat_checker</span>       <span class="n">SOURCE_004</span>  <span class="n">SOURCE_013</span>  <span class="n">SOURCE_022</span>
<span class="n">Par_file</span>                         <span class="n">SOURCE_005</span>  <span class="n">SOURCE_014</span>  <span class="n">SOURCE_023</span>
<span class="n">Par_file_Tape2007_132rec_checker</span>     <span class="n">SOURCE_006</span>  <span class="n">SOURCE_015</span>  <span class="n">SOURCE_024</span>
<span class="n">Par_file_Tape2007_onerec</span>         <span class="n">SOURCE_007</span>  <span class="n">SOURCE_016</span>  <span class="n">SOURCE_025</span>
<span class="n">proc000000_model_velocity</span><span class="o">.</span><span class="n">dat_input</span>  <span class="n">SOURCE_008</span>  <span class="n">SOURCE_017</span>  <span class="n">STATIONS</span>
<span class="n">SOURCE</span>                                   <span class="n">SOURCE_009</span>  <span class="n">SOURCE_018</span>  <span class="n">STATIONS_checker</span>
<span class="n">SOURCE_001</span>                       <span class="n">SOURCE_010</span>  <span class="n">SOURCE_019</span>
<span class="n">SOURCE_002</span>                       <span class="n">SOURCE_011</span>  <span class="n">SOURCE_020</span>
</pre></div>
</div>
</div>
<div class="section" id="c-generate-initial-and-target-models">
<h4>1c. Generate initial and target models<a class="headerlink" href="#c-generate-initial-and-target-models" title="Permalink to this headline"></a></h4>
<p>Since we’re doing a synthetic-synthetic inversion, we need to manually
set up the velocity models with which we generate our synthetic
waveforms. The naming conventions for these models are:</p>
<ol class="arabic simple">
<li><p><strong>MODEL_INIT:</strong> The initial or starting model. Used to generate the
actual synthetic seismograms. This is considered M00.</p></li>
<li><p><strong>MODEL_TRUE:</strong> The target or true model. Used to generate ‘data’
(also synthetic). This is the reference model that our inversion is
trying to resolve.</p></li>
</ol>
<p>The starting model is defined as a homogeneous halfspace uin the
Tape2007 example problem. We will need to run both <code class="docutils literal notranslate"><span class="pre">xmeshfem2D</span></code> and
<code class="docutils literal notranslate"><span class="pre">xspecfem2D</span></code> to generate the required velocity model database files.
We will generate our target model by slightly perturbing the parameters
of the initial model.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can use the SeisFlows3 command line option <cite>seisflows sempar</cite> to directly edit the SPECFEM2D Par_file in the command line. This will work for the SPECFEM3D Par_file as well.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_DATA</span><span class="p">)</span>

<span class="c1"># Ensure that SPECFEM2D outputs the velocity model in the expected binary format</span>
<span class="o">!</span> seisflows sempar setup_with_binary_database <span class="m">1</span>  # allow creation of .bin files
<span class="o">!</span> seisflows sempar save_model binary  # output model <span class="k">in</span> .bin database format
<span class="o">!</span> seisflows sempar save_ascii_kernels .false.  # output kernels <span class="k">in</span> .bin format, not ASCII
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setup_with_binary_database</span><span class="p">:</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="n">SAVE_MODEL</span><span class="p">:</span> <span class="n">default</span> <span class="o">-&gt;</span> <span class="n">binary</span>
<span class="n">save_ASCII_kernels</span><span class="p">:</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SPECFEM requires that we create the OUTPUT_FILES directory before running</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">)</span>

<span class="o">!</span> ls
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bin</span>  <span class="n">DATA</span>  <span class="n">OUTPUT_FILES</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># GENERATE MODEL_INIT</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>

<span class="c1"># Run the mesher and solver to generate our initial model</span>
<span class="o">!</span> ./bin/xmeshfem2D &gt; OUTPUT_FILES/mesher_log.txt
<span class="o">!</span> ./bin/xspecfem2D &gt; OUTPUT_FILES/solver_log.txt

<span class="c1"># Move the model files (*.bin) into the OUTPUT_FILES directory, where SeisFlows3 expects them</span>
<span class="o">!</span> mv DATA/*bin OUTPUT_FILES

<span class="c1"># Make sure we don&#39;t overwrite this initial model when creating our target model in the next step</span>
<span class="o">!</span> mv OUTPUT_FILES OUTPUT_FILES_INIT

<span class="o">!</span> head OUTPUT_FILES_INIT/solver_log.txt
<span class="o">!</span> tail OUTPUT_FILES_INIT/solver_log.txt
</pre></div>
</div>
<pre class="literal-block"><strong>******************************************</strong>
<a href="#id1"><span class="problematic" id="id2">**</span></a>** Specfem 2-D Solver - serial version  <a href="#id3"><span class="problematic" id="id4">**</span></a>**
<strong>******************************************</strong>

Running Git version of the code corresponding to commit cf89366717d9435985ba852ef1d41a10cee97884
dating From Date:   Mon Nov 29 23:20:51 2021 -0800


NDIM =            2
-------------------------------------------------------------------------------
Program SPECFEM2D:
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
Tape-Liu-Tromp (GJI 2007)
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
D a t e : 29 - 04 - 2022                                 T i m e  : 12:25:24
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------</pre>
<hr class="docutils" />
<p>Now we want to perturb the initial model to create our target model
(<strong>MODEL_TRUE</strong>). The seisflows command line subargument
<code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">sempar</span> <span class="pre">velocity_model</span></code> will let us view and edit the
velocity model. You can also do this manually by editing the Par_file
directly.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># GENERATE MODEL_TRUE</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_DATA</span><span class="p">)</span>

<span class="c1"># Edit the Par_file by increasing velocities by ~10%</span>
<span class="o">!</span> seisflows sempar velocity_model <span class="s1">&#39;1 1 2600.d0 5900.d0 3550.0d0 0 0 10.d0 10.d0 0 0 0 0 0 0&#39;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VELOCITY_MODEL</span><span class="p">:</span>

<span class="mi">1</span> <span class="mi">1</span> <span class="mf">2600.</span><span class="n">d0</span> <span class="mf">5800.</span><span class="n">d0</span> <span class="mf">3500.0</span><span class="n">d0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">10.</span><span class="n">d0</span> <span class="mf">10.</span><span class="n">d0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">-&gt;</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mf">2600.</span><span class="n">d0</span> <span class="mf">5900.</span><span class="n">d0</span> <span class="mf">3550.0</span><span class="n">d0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mf">10.</span><span class="n">d0</span> <span class="mf">10.</span><span class="n">d0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-run the mesher and solver to generate our target velocity model</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_WORKDIR</span><span class="p">)</span>

<span class="c1"># Make sure the ./OUTPUT_FILES directory exists since we moved the old one</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">SPECFEM2D_OUTPUT</span><span class="p">)</span>

<span class="c1"># Run the binaries to generate MODEL_TRUE</span>
<span class="o">!</span> ./bin/xmeshfem2D &gt; OUTPUT_FILES/mesher_log.txt
<span class="o">!</span> ./bin/xspecfem2D &gt; OUTPUT_FILES/solver_log.txt

<span class="c1"># Move all the relevant files into OUTPUT_FILES</span>
<span class="o">!</span> mv ./DATA/*bin OUTPUT_FILES
<span class="o">!</span> mv OUTPUT_FILES OUTPUT_FILES_TRUE

<span class="o">!</span> head OUTPUT_FILES_INIT/solver_log.txt
<span class="o">!</span> tail OUTPUT_FILES_INIT/solver_log.txt
</pre></div>
</div>
<pre class="literal-block"><strong>******************************************</strong>
<a href="#id5"><span class="problematic" id="id6">**</span></a>** Specfem 2-D Solver - serial version  <a href="#id7"><span class="problematic" id="id8">**</span></a>**
<strong>******************************************</strong>

Running Git version of the code corresponding to commit cf89366717d9435985ba852ef1d41a10cee97884
dating From Date:   Mon Nov 29 23:20:51 2021 -0800


NDIM =            2
-------------------------------------------------------------------------------
Program SPECFEM2D:
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
Tape-Liu-Tromp (GJI 2007)
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
D a t e : 29 - 04 - 2022                                 T i m e  : 12:25:24
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Great, we have all the necessary SPECFEM files to run our SeisFlows3 inversion!</span>
<span class="o">!</span> ls
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bin</span>  <span class="n">DATA</span>  <span class="n">OUTPUT_FILES_INIT</span>  <span class="n">OUTPUT_FILES_TRUE</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="initialize-seisflows3-sf3">
<h3>2. Initialize SeisFlows3 (SF3)<a class="headerlink" href="#initialize-seisflows3-sf3" title="Permalink to this headline"></a></h3>
<p>In this Section we will look at a SeisFlows3 working directory,
parameter file, and working state.</p>
<div class="section" id="a-sf3-working-directory-and-parameter-file">
<h4>2a. SF3 working directory and parameter file<a class="headerlink" href="#a-sf3-working-directory-and-parameter-file" title="Permalink to this headline"></a></h4>
<p>As with SPECFEM, SeisFlows3 requires a parameter file
(<strong>parameters.yaml</strong>) that controls how an automated workflow will
proceed. Because SeisFlows3 is modular, there are a large number of
potential parameters which may be present in SF3 parameter file, as each
sub-module may have its own set of unique parameters.</p>
<p>In contrast to SPECFEM’s method of listing all available parameters and
leaving it up the User to determine which ones are relevant to them,
SeisFlows3 dynamically builds its parameter file based on User inputs.
In this subsection we will use the built-in SeisFlows3 command line
tools to generate and populate the parameter file.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a class="reference external" href="parameter_file.html">parameter file documentation page</a> for a more in depth exploration of this central SeisFlows3 file.</p>
</div>
<p>In the previous section we saw the <code class="docutils literal notranslate"><span class="pre">sempar</span></code> command in action. We can
use the <code class="docutils literal notranslate"><span class="pre">-h</span></code> or help flag to list all available SiesFlows3 command
line commands.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows -h
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">seisflows</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">w</span> <span class="p">[</span><span class="n">WORKDIR</span><span class="p">]]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="p">[</span><span class="n">PARAMETER_FILE</span><span class="p">]]</span>
                 <span class="p">{</span><span class="n">setup</span><span class="p">,</span><span class="n">configure</span><span class="p">,</span><span class="n">init</span><span class="p">,</span><span class="n">submit</span><span class="p">,</span><span class="n">resume</span><span class="p">,</span><span class="n">restart</span><span class="p">,</span><span class="n">clean</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">sempar</span><span class="p">,</span><span class="n">check</span><span class="p">,</span><span class="nb">print</span><span class="p">,</span><span class="n">convert</span><span class="p">,</span><span class="n">reset</span><span class="p">,</span><span class="n">debug</span><span class="p">,</span><span class="n">edit</span><span class="p">,</span><span class="n">examples</span><span class="p">}</span>
                 <span class="o">...</span>

<span class="o">================================================================================</span>

                     <span class="n">SeisFlows3</span><span class="p">:</span> <span class="n">Waveform</span> <span class="n">Inversion</span> <span class="n">Package</span>

<span class="o">================================================================================</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">w</span> <span class="p">[</span><span class="n">WORKDIR</span><span class="p">],</span> <span class="o">--</span><span class="n">workdir</span> <span class="p">[</span><span class="n">WORKDIR</span><span class="p">]</span>
                        <span class="n">The</span> <span class="n">SeisFlows</span> <span class="n">working</span> <span class="n">directory</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">cwd</span>
  <span class="o">-</span><span class="n">p</span> <span class="p">[</span><span class="n">PARAMETER_FILE</span><span class="p">],</span> <span class="o">--</span><span class="n">parameter_file</span> <span class="p">[</span><span class="n">PARAMETER_FILE</span><span class="p">]</span>
                        <span class="n">Parameters</span> <span class="n">file</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;parameters.yaml&#39;</span>

<span class="n">command</span><span class="p">:</span>
  <span class="n">Available</span> <span class="n">SeisFlows</span> <span class="n">arguments</span> <span class="ow">and</span> <span class="n">their</span> <span class="n">intended</span> <span class="n">usages</span>

    <span class="n">setup</span>               <span class="n">Setup</span> <span class="n">working</span> <span class="n">directory</span> <span class="kn">from</span> <span class="nn">scratch</span>
    <span class="n">configure</span>           <span class="n">Fill</span> <span class="n">parameter</span> <span class="n">file</span> <span class="k">with</span> <span class="n">defaults</span>
    <span class="n">init</span>                <span class="n">Initiate</span> <span class="n">working</span> <span class="n">environment</span>
    <span class="n">submit</span>              <span class="n">Submit</span> <span class="n">initial</span> <span class="n">workflow</span> <span class="n">to</span> <span class="n">system</span>
    <span class="n">resume</span>              <span class="n">Re</span><span class="o">-</span><span class="n">submit</span> <span class="n">previous</span> <span class="n">workflow</span> <span class="n">to</span> <span class="n">system</span>
    <span class="n">restart</span>             <span class="n">Remove</span> <span class="n">current</span> <span class="n">environment</span> <span class="ow">and</span> <span class="n">submit</span> <span class="n">new</span> <span class="n">workflow</span>
    <span class="n">clean</span>               <span class="n">Remove</span> <span class="n">files</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">an</span> <span class="n">active</span> <span class="n">working</span> <span class="n">environment</span>
    <span class="n">par</span>                 <span class="n">View</span> <span class="ow">and</span> <span class="n">edit</span> <span class="n">SeisFlows3</span> <span class="n">parameter</span> <span class="n">file</span>
    <span class="n">sempar</span>              <span class="n">View</span> <span class="ow">and</span> <span class="n">edit</span> <span class="n">SPECFEM</span> <span class="n">parameter</span> <span class="n">file</span>
    <span class="n">check</span>               <span class="n">Check</span> <span class="n">state</span> <span class="n">of</span> <span class="n">an</span> <span class="n">active</span> <span class="n">environment</span>
    <span class="nb">print</span>               <span class="n">Print</span> <span class="n">information</span> <span class="n">related</span> <span class="n">to</span> <span class="n">an</span> <span class="n">active</span> <span class="n">environment</span>
    <span class="n">convert</span>             <span class="n">Convert</span> <span class="n">model</span> <span class="n">file</span> <span class="nb">format</span>
    <span class="n">reset</span>               <span class="n">Reset</span> <span class="n">modules</span> <span class="n">within</span> <span class="n">an</span> <span class="n">active</span> <span class="n">state</span>
    <span class="n">debug</span>               <span class="n">Start</span> <span class="n">interactive</span> <span class="n">debug</span> <span class="n">environment</span>
    <span class="n">edit</span>                <span class="n">Open</span> <span class="n">source</span> <span class="n">code</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">text</span> <span class="n">editor</span>
    <span class="n">examples</span>            <span class="n">Look</span> <span class="n">at</span> <span class="ow">and</span> <span class="n">run</span> <span class="n">pre</span><span class="o">-</span><span class="n">configured</span> <span class="n">example</span> <span class="n">problems</span>

<span class="s1">&#39;seisflows [command] -h&#39;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">detailed</span> <span class="n">descriptions</span> <span class="n">of</span> <span class="n">each</span> <span class="n">command</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The command &#39;setup&#39; creates the &#39;parameters.yaml&#39; file that controls all of SeisFlows3</span>
<span class="c1"># the &#39;-f&#39; flag removes any exist &#39;parameters.yaml&#39; file that might be in the directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">)</span>
<span class="o">!</span> seisflows setup -f
<span class="o">!</span> ls
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">creating</span> <span class="n">parameter</span> <span class="n">file</span><span class="p">:</span> <span class="n">parameters</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">parameters</span><span class="o">.</span><span class="n">yaml</span>  <span class="n">specfem2d</span>  <span class="n">specfem2d_workdir</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s have a look at this file, which has not yet been populated</span>
<span class="o">!</span> cat parameters.yaml
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># //////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">#</span>
<span class="c1">#                        SeisFlows3 YAML Parameter File</span>
<span class="c1">#</span>
<span class="c1"># //////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">#</span>
<span class="c1"># Modules correspond to the structure of the source code, and determine</span>
<span class="c1"># SeisFlows3&#39; behavior at runtime. Each module requires its own sub-parameters.</span>
<span class="c1">#</span>
<span class="c1"># .. rubric::</span>
<span class="c1">#   - To determine available options for modules listed below, run:</span>
<span class="c1">#       &gt; seisflows print module</span>
<span class="c1">#   - To auto-fill with docstrings and default values (recommended), run:</span>
<span class="c1">#       &gt; seisflows configure</span>
<span class="c1">#   - To set values as NoneType, use: null</span>
<span class="c1">#   - To set values as infinity, use: inf</span>
<span class="c1">#</span>
<span class="c1">#                                    MODULES</span>
<span class="c1">#                                    ///////</span>
<span class="c1"># WORKFLOW (str):    The method for running SeisFlows3; equivalent to main()</span>
<span class="c1"># SOLVER (str):      External numerical solver to use for waveform simulations</span>
<span class="c1"># SYSTEM (str):      Computer architecture of the system being used</span>
<span class="c1"># OPTIMIZE (str):    Optimization algorithm for the inverse problem</span>
<span class="c1"># PREPROCESS (str):  Preprocessing schema for waveform data</span>
<span class="c1"># POSTPROCESS (str): Postprocessing schema for kernels and gradients</span>
<span class="c1"># ==============================================================================</span>
<span class="n">WORKFLOW</span><span class="p">:</span> <span class="n">inversion</span>
<span class="n">SOLVER</span><span class="p">:</span> <span class="n">specfem2d</span>
<span class="n">SYSTEM</span><span class="p">:</span> <span class="n">workstation</span>
<span class="n">OPTIMIZE</span><span class="p">:</span> <span class="n">LBFGS</span>
<span class="n">PREPROCESS</span><span class="p">:</span> <span class="n">base</span>
<span class="n">POSTPROCESS</span><span class="p">:</span> <span class="n">base</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can use the `seisflows print modules` command to list out the available options</span>
<span class="o">!</span> seisflows print modules
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                               SEISFLOWS3 MODULES
                               //////////////////
&#39;+&#39;: package, &#39;-&#39;: module, &#39;*&#39;: class

+ SYSTEM
    - seisflows3
        * base
        * cluster
        * lsf
        * slurm
        * workstation
    - seisflows3-super
        * chinook
        * maui
+ PREPROCESS
    - seisflows3
        * base
        * pyatoa
    - seisflows3-super
        * pyatoa_nz
+ SOLVER
    - seisflows3
        * base
        * specfem2d
        * specfem3d
        * specfem3d_globe
    - seisflows3-super
        * specfem3d_maui
+ POSTPROCESS
    - seisflows3
        * base
    - seisflows3-super
+ OPTIMIZE
    - seisflows3
        * LBFGS
        * NLCG
        * base
    - seisflows3-super
+ WORKFLOW
    - seisflows3
        * base
        * inversion
        * migration
        * test
    - seisflows3-super
        * thrifty_inversion
        * thrifty_maui
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For this example, we can use most of the default modules, however we need to</span>
<span class="c1"># change the SOLVER module to let SeisFlows3 know we&#39;re using SPECFEM2D (as opposed to 3D)</span>
<span class="o">!</span> seisflows par solver specfem2d
<span class="o">!</span> cat parameters.yaml
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SOLVER</span><span class="p">:</span> <span class="n">specfem2d</span> <span class="o">-&gt;</span> <span class="n">specfem2d</span>
<span class="c1"># //////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">#</span>
<span class="c1">#                        SeisFlows3 YAML Parameter File</span>
<span class="c1">#</span>
<span class="c1"># //////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">#</span>
<span class="c1"># Modules correspond to the structure of the source code, and determine</span>
<span class="c1"># SeisFlows3&#39; behavior at runtime. Each module requires its own sub-parameters.</span>
<span class="c1">#</span>
<span class="c1"># .. rubric::</span>
<span class="c1">#   - To determine available options for modules listed below, run:</span>
<span class="c1">#       &gt; seisflows print module</span>
<span class="c1">#   - To auto-fill with docstrings and default values (recommended), run:</span>
<span class="c1">#       &gt; seisflows configure</span>
<span class="c1">#   - To set values as NoneType, use: null</span>
<span class="c1">#   - To set values as infinity, use: inf</span>
<span class="c1">#</span>
<span class="c1">#                                    MODULES</span>
<span class="c1">#                                    ///////</span>
<span class="c1"># WORKFLOW (str):    The method for running SeisFlows3; equivalent to main()</span>
<span class="c1"># SOLVER (str):      External numerical solver to use for waveform simulations</span>
<span class="c1"># SYSTEM (str):      Computer architecture of the system being used</span>
<span class="c1"># OPTIMIZE (str):    Optimization algorithm for the inverse problem</span>
<span class="c1"># PREPROCESS (str):  Preprocessing schema for waveform data</span>
<span class="c1"># POSTPROCESS (str): Postprocessing schema for kernels and gradients</span>
<span class="c1"># ==============================================================================</span>
<span class="n">WORKFLOW</span><span class="p">:</span> <span class="n">inversion</span>
<span class="n">SOLVER</span><span class="p">:</span> <span class="n">specfem2d</span>
<span class="n">SYSTEM</span><span class="p">:</span> <span class="n">workstation</span>
<span class="n">OPTIMIZE</span><span class="p">:</span> <span class="n">LBFGS</span>
<span class="n">PREPROCESS</span><span class="p">:</span> <span class="n">base</span>
<span class="n">POSTPROCESS</span><span class="p">:</span> <span class="n">base</span>
</pre></div>
</div>
<hr class="docutils" />
<p>The <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">configure</span></code> command populates the parameter file based
on the chosen modules. SeisFlows3 will attempt to fill in all parameters
with default values when possible, but values that the User <strong>MUST</strong> set
will be denoted by the value:</p>
<blockquote>
<div><p><strong>!!! REQUIRED PARAMETER !!!</strong></p>
</div></blockquote>
<p>SeisFlows3 will not work until all of these required parameters are set
by the User. Docstrings above each module show descriptions and
available options for each of these parameters. In the follownig cell we
will use the <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">par</span></code> command to edit the parameters.yaml file
directly, replacing each of the required parameters with a chosen value.
Comments next to each evaluation describe the choice for each.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows configure
<span class="o">!</span> cat parameters.yaml
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filling parameters.yaml w/ default values
# //////////////////////////////////////////////////////////////////////////////
#
#                        SeisFlows3 YAML Parameter File
#
# //////////////////////////////////////////////////////////////////////////////
#
# Modules correspond to the structure of the source code, and determine
# SeisFlows3&#39; behavior at runtime. Each module requires its own sub-parameters.
#
# .. rubric::
#   - To determine available options for modules listed below, run:
#       &gt; seisflows print module
#   - To auto-fill with docstrings and default values (recommended), run:
#       &gt; seisflows configure
#   - To set values as NoneType, use: null
#   - To set values as infinity, use: inf
#
#                                    MODULES
#                                    ///////
# WORKFLOW (str):    The method for running SeisFlows3; equivalent to main()
# SOLVER (str):      External numerical solver to use for waveform simulations
# SYSTEM (str):      Computer architecture of the system being used
# OPTIMIZE (str):    Optimization algorithm for the inverse problem
# PREPROCESS (str):  Preprocessing schema for waveform data
# POSTPROCESS (str): Postprocessing schema for kernels and gradients
# ==============================================================================
WORKFLOW: inversion
SOLVER: specfem2d
SYSTEM: workstation
OPTIMIZE: LBFGS
PREPROCESS: base
POSTPROCESS: base

# =============================================================================
#                                    SYSTEM
#                                    //////
# TITLE (str):
#   The name used to submit jobs to the system, defaults to the name of the
#   working directory
# PRECHECK (list):
#   A list of parameters that will be displayed to stdout before &#39;submit&#39; or
#   &#39;resume&#39; is run. Useful for manually reviewing important parameters prior
#   to system submission
# LOG_LEVEL (str):
#   Verbosity output of SF3 logger. Available from least to most verbosity:
#   &#39;CRITICAL&#39;, &#39;WARNING&#39;, &#39;INFO&#39;, &#39;DEBUG&#39;; defaults to &#39;DEBUG&#39;
# VERBOSE (bool):
#   Level of verbosity provided to the output log. If True, log statements
#   will declare what module/class/function they are being called from.
#   Useful for debugging but also very noisy.
# MPIEXEC (str):
#   Function used to invoke executables on the system. For example &#39;srun&#39; on
#   SLURM systems, or &#39;./&#39; on a workstation. If left blank, will guess based
#   on the system.
# NTASK (int):
#   Number of separate, individual tasks. Also equal to the number of desired
#   sources in workflow
# NPROC (int):
#   Number of processor to use for each simulation
# =============================================================================
TITLE: sf3_specfem2d_example
PRECHECK:
    - TITLE
LOG_LEVEL: DEBUG
VERBOSE: False
MPIEXEC:
NTASK: 1
NPROC: 1

# =============================================================================
#                                  PREPROCESS
#                                  //////////
# MISFIT (str):
#   Misfit function for waveform comparisons, for available see
#   seisflows.plugins.misfit
# BACKPROJECT (str):
#   Backprojection function for migration, for available see
#   seisflows.plugins.adjoint
# NORMALIZE (list):
#   Data normalization parameters used to normalize the amplitudes of
#   waveforms. Choose from two sets: ENORML1: normalize per event by L1 of
#   traces; OR ENORML2: normalize per event by L2 of traces; AND TNORML1:
#   normalize per trace by L1 of itself; OR TNORML2: normalize per trace by
#   L2 of itself
# FILTER (str):
#   Data filtering type, available options are:BANDPASS (req. MIN/MAX
#   PERIOD/FREQ);LOWPASS (req. MAX_FREQ or MIN_PERIOD); HIGHPASS (req.
#   MIN_FREQ or MAX_PERIOD)
# MIN_PERIOD (float):
#   Minimum filter period applied to time series.See also MIN_FREQ, MAX_FREQ,
#   if User defines FREQ parameters, they will overwrite PERIOD parameters.
# MAX_PERIOD (float):
#   Maximum filter period applied to time series.See also MIN_FREQ, MAX_FREQ,
#   if User defines FREQ parameters, they will overwrite PERIOD parameters.
# MIN_FREQ (float):
#   Maximum filter frequency applied to time series.See also MIN_PERIOD,
#   MAX_PERIOD, if User defines FREQ parameters, they will overwrite PERIOD
#   parameters.
# MAX_FREQ (float):
#   Maximum filter frequency applied to time series,See also MIN_PERIOD,
#   MAX_PERIOD, if User defines FREQ parameters, they will overwrite PERIOD
#   parameters.
# MUTE (list):
#   Data mute parameters used to zero out early / late arrivals or offsets.
#   Choose any number of: EARLY: mute early arrivals; LATE: mute late
#   arrivals; SHORT: mute short source-receiver distances; LONG: mute long
#   source-receiver distances
# =============================================================================
MISFIT: waveform
BACKPROJECT: null
NORMALIZE: []
FILTER: null
MIN_PERIOD:
MAX_PERIOD:
MIN_FREQ:
MAX_FREQ:
MUTE: []

# =============================================================================
#                                    SOLVER
#                                    //////
# MATERIALS (str):
#   Material parameters used to define model. Available: [&#39;ELASTIC&#39;: Vp, Vs,
#   &#39;ACOUSTIC&#39;: Vp, &#39;ISOTROPIC&#39;, &#39;ANISOTROPIC&#39;]
# DENSITY (str):
#   How to treat density during inversion. Available: [&#39;CONSTANT&#39;: Do not
#   update density, &#39;VARIABLE&#39;: Update density]
# ATTENUATION (str):
#   If True, turn on attenuation during forward simulations, otherwise set
#   attenuation off. Attenuation is always off for adjoint simulations.
# COMPONENTS (str):
#   Components used to generate data, formatted as a single string, e.g. ZNE
#   or NZ or E
# SOLVERIO (int):
#   The format external solver files. Available: [&#39;fortran_binary&#39;, &#39;adios&#39;]
# NT (float):
#   Number of time steps set in the SPECFEM Par_file
# DT (float):
#   Time step or delta set in the SPECFEM Par_file
# F0 (float):
#   Dominant source frequency
# FORMAT (float):
#   Format of synthetic waveforms used during workflow, available options:
#   [&#39;ascii&#39;, &#39;su&#39;]
# SOURCE_PREFIX (str):
#   Prefix of SOURCE files in path SPECFEM_DATA. By default, &#39;SOURCE&#39; for
#   SPECFEM2D
# =============================================================================
MATERIALS: !!! REQUIRED PARAMETER !!!
DENSITY: !!! REQUIRED PARAMETER !!!
ATTENUATION: !!! REQUIRED PARAMETER !!!
COMPONENTS: ZNE
SOLVERIO: fortran_binary
NT: !!! REQUIRED PARAMETER !!!
DT: !!! REQUIRED PARAMETER !!!
F0: !!! REQUIRED PARAMETER !!!
FORMAT: !!! REQUIRED PARAMETER !!!
SOURCE_PREFIX: SOURCE

# =============================================================================
#                                  POSTPROCESS
#                                  ///////////
# SMOOTH_H (float):
#   Gaussian half-width for horizontal smoothing in units of meters. If 0.,
#   no smoothing applied
# SMOOTH_V (float):
#   Gaussian half-width for vertical smoothing in units of meters
# TASKTIME_SMOOTH (int):
#   Large radii smoothing may take longer than normal tasks. Allocate
#   additional smoothing task time as a multiple of TASKTIME
# =============================================================================
SMOOTH_H: 0.0
SMOOTH_V: 0.0
TASKTIME_SMOOTH: 1

# =============================================================================
#                                   OPTIMIZE
#                                   ////////
# LINESEARCH (str):
#   Algorithm to use for line search, see seisflows.plugins.line_search for
#   available choices
# PRECOND (str):
#   Algorithm to use for preconditioning gradients, see
#   seisflows3.plugins.preconds for available choices
# STEPCOUNTMAX (int):
#   Max number of trial steps in line search before a change in line search
#   behavior
# STEPLENINIT (float):
#   Initial line search step length, as a fraction of current model
#   parameters
# STEPLENMAX (float):
#   Max allowable step length, as a fraction of current model parameters
# LBFGSMEM (int):
#   Max number of previous gradients to retain in local memory
# LBFGSMAX (int):
#   LBFGS periodic restart interval, between 1 and &#39;inf&#39;
# LBFGSTHRESH (float):
#   LBFGS angle restart threshold
# =============================================================================
LINESEARCH: Backtrack
PRECOND:
STEPCOUNTMAX: 10
STEPLENINIT: 0.05
STEPLENMAX: 0.5
LBFGSMEM: 3
LBFGSMAX: inf
LBFGSTHRESH: 0.0

# =============================================================================
#                                   WORKFLOW
#                                   ////////
# CASE (str):
#   Type of inversion, available: [&#39;data&#39;: real data inversion, &#39;synthetic&#39;:
#   synthetic-synthetic inversion]
# RESUME_FROM (str):
#   Name of task to resume inversion from
# STOP_AFTER (str):
#   Name of task to stop inversion after finishing
# SAVEMODEL (bool):
#   Save final model files after each iteration
# SAVEGRADIENT (bool):
#   Save gradient files after each iteration
# SAVEKERNELS (bool):
#   Save event kernel files after each iteration
# SAVETRACES (bool):
#   Save waveform traces after each iteration
# SAVERESIDUALS (bool):
#   Save waveform residuals after each iteration
# SAVEAS (str):
#   Format to save models, gradients, kernels. Available: [&#39;binary&#39;: save
#   files in native SPECFEM .bin format, &#39;vector&#39;: save files as NumPy .npy
#   files, &#39;both&#39;: save as both binary and vectors]
# BEGIN (int):
#   First iteration of workflow, 1 &lt;= BEGIN &lt;= inf
# END (int):
#   Last iteration of workflow, BEGIN &lt;= END &lt;= inf
# =============================================================================
CASE: !!! REQUIRED PARAMETER !!!
RESUME_FROM:
STOP_AFTER:
SAVEMODEL: True
SAVEGRADIENT: True
SAVEKERNELS: False
SAVETRACES: False
SAVERESIDUALS: False
SAVEAS: binary
BEGIN: 1
END: !!! REQUIRED PARAMETER !!!

# =============================================================================
#                                     PATHS
#                                     /////
# SCRATCH:
#   scratch path to hold temporary data during workflow
# OUTPUT:
#   directory to save workflow outputs to disk
# SYSTEM:
#   scratch path to hold any system related data
# LOCAL:
#   path to local data to be used during workflow
# LOGFILE:
#   the main output log file where all processes will track their status
# SOLVER:
#   scratch path to hold solver working directories
# SPECFEM_BIN:
#   path to the SPECFEM binary executables
# SPECFEM_DATA:
#   path to the SPECFEM DATA/ directory containing the &#39;Par_file&#39;, &#39;STATIONS&#39;
#   file and &#39;CMTSOLUTION&#39; files
# DATA:
#   path to data available to workflow
# MASK:
#   Directory to mask files for gradient masking
# OPTIMIZE:
#   scratch path to store data related to nonlinear optimization
# MODEL_INIT:
#   location of the initial model to be used for workflow
# MODEL_TRUE:
#   Target model to be used for PAR.CASE == &#39;synthetic&#39;
# FUNC:
#   scratch path to store data related to function evaluations
# GRAD:
#   scratch path to store data related to gradient evaluations
# HESS:
#   scratch path to store data related to Hessian evaluations
# =============================================================================
PATHS:
    SCRATCH: /home/bchow/Work/work/sf3_specfem2d_example/scratch
    OUTPUT: /home/bchow/Work/work/sf3_specfem2d_example/output
    SYSTEM: /home/bchow/Work/work/sf3_specfem2d_example/scratch/system
    LOCAL:
    LOGFILE: /home/bchow/Work/work/sf3_specfem2d_example/output_sf3.txt
    SOLVER: /home/bchow/Work/work/sf3_specfem2d_example/scratch/solver
    SPECFEM_BIN: !!! REQUIRED PATH !!!
    SPECFEM_DATA: !!! REQUIRED PATH !!!
    DATA:
    MASK:
    OPTIMIZE: /home/bchow/Work/work/sf3_specfem2d_example/scratch/optimize
    MODEL_INIT: !!! REQUIRED PATH !!!
    MODEL_TRUE:
    FUNC: /home/bchow/Work/work/sf3_specfem2d_example/scratch/scratch
    GRAD: /home/bchow/Work/work/sf3_specfem2d_example/scratch/evalgrad
    HESS: /home/bchow/Work/work/sf3_specfem2d_example/scratch/evalhess
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can check which parameters we will NEED to fill out before running the workflow with the --required flag</span>
<span class="o">!</span> seisflows par --required
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!!! REQUIRED PARAMETER !!!
==========================
    MATERIALS
    DENSITY
    ATTENUATION
    NT
    DT
    F0
    FORMAT
    CASE
    END
!!! REQUIRED PATH !!!
=====================
    SPECFEM_BIN
    SPECFEM_DATA
    MODEL_INIT
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EDIT THE SEISFLOWS3 PARAMETER FILE</span>
<span class="o">!</span> seisflows par materials elastic  # how the velocity model is parameterized
<span class="o">!</span> seisflows par density constant  # update density or keep constant
<span class="o">!</span> seisflows par attenuation False
<span class="o">!</span> seisflows par nt <span class="m">5000</span>  # <span class="nb">set</span> by SPECFEM2D Par_file
<span class="o">!</span> seisflows par dt .06  # <span class="nb">set</span> by SPECFEM2D Par_file
<span class="o">!</span> seisflows par f0 <span class="m">0</span>.084  # <span class="nb">set</span> by SOURCE file
<span class="o">!</span> seisflows par format ascii  # how to output synthetic seismograms
<span class="o">!</span> seisflows par begin <span class="m">1</span>  # first iteration
<span class="o">!</span> seisflows par end <span class="m">1</span>  # final iteration -- we will only run <span class="m">1</span>
<span class="o">!</span> seisflows par <span class="k">case</span> synthetic  # synthetic-synthetic means we need both INIT and TRUE models

<span class="c1"># Use Python syntax here to access path constants</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seisflows par specfem_bin </span><span class="si">{</span><span class="n">SPECFEM2D_BIN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># set path to SPECFEM2D binaries</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seisflows par specfem_data </span><span class="si">{</span><span class="n">SPECFEM2D_DATA</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># set path to SEPCFEM2D DATA/</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seisflows par model_init </span><span class="si">{</span><span class="n">SPECFEM2D_MODEL_INIT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># set path to INIT model</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;seisflows par model_true </span><span class="si">{</span><span class="n">SPECFEM2D_MODEL_TRUE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># set path to TRUE model</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>MATERIALS: !!! REQUIRED PARAMETER !!! -&gt; elastic
DENSITY: !!! REQUIRED PARAMETER !!! -&gt; constant
ATTENUATION: !!! REQUIRED PARAMETER !!! -&gt; False
NT: !!! REQUIRED PARAMETER !!! -&gt; 5000
DT: !!! REQUIRED PARAMETER !!! -&gt; .06
F0: !!! REQUIRED PARAMETER !!! -&gt; 0.084
FORMAT: !!! REQUIRED PARAMETER !!! -&gt; ascii
BEGIN: 1 -&gt; 1
END: !!! REQUIRED PARAMETER !!! -&gt; 1
CASE: !!! REQUIRED PARAMETER !!! -&gt; synthetic
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>
</pre></div>
</div>
<hr class="docutils" />
<p>One last thing, we will need to edit the SPECFEM2D Par_file parameter
<code class="docutils literal notranslate"><span class="pre">MODEL</span></code> such that <code class="docutils literal notranslate"><span class="pre">xmeshfem2d</span></code> reads our pre-built velocity models
(<a href="#id9"><span class="problematic" id="id10">*</span></a>.bin files) rather than the meshing parameters defined in the
Par_file.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">SPECFEM2D_DATA</span><span class="p">)</span>
<span class="o">!</span> seisflows sempar model gll
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MODEL</span><span class="p">:</span> <span class="n">default</span> <span class="o">-&gt;</span> <span class="n">gll</span>
</pre></div>
</div>
</div>
<div class="section" id="b-initialize-sf3-working-state">
<h4>2b. Initialize SF3 working state<a class="headerlink" href="#b-initialize-sf3-working-state" title="Permalink to this headline"></a></h4>
<p>The SeisFlows3 command <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">init</span></code> will generate the a SeisFlows3
working state without submitting any jobs to the system. This is useful
for testing to see if the user has set an acceptable parameter file, and
if SeisFlows3 is working as expected.</p>
<p>The result of running <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">init</span></code> is a collection of pickle (<a href="#id11"><span class="problematic" id="id12">*</span></a>.p)
and JSON files which define the active Python environment. SeisFlows3
relies directly on these files to determine where it is in a workflow.
Throughout an active workflow, SeisFlows3 will checkpoint itself to
these pickle and JSON files such that if a workflow finishes or crashes,
the User can resume a workflow from the last checkpointed state rather
than needing to restart the workflow.</p>
<blockquote>
<div><p><strong>DEBUG MODE:</strong> After running <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">init</span></code> you can explore the
SeisFlows3 working state in an interactive iPython environment by
running <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">debug</span></code>. This will open up an iPython environment
in which the active working state is loaded and accessible The debug
mode is invaluable for exploring the SeisFlows3 working state,
debugging errors, and performing manual manipulations to an otherwise
automated tool. You can try for yourself by running debug mode and
typing ‘preprocess’ to access the active preprocess module.</p>
</div></blockquote>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">)</span>
<span class="o">!</span> seisflows init
<span class="o">!</span> ls output
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instantiating</span> <span class="n">SeisFlows3</span> <span class="n">working</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">directory</span><span class="p">:</span> <span class="n">output</span>
<span class="n">seisflows_optimize</span><span class="o">.</span><span class="n">p</span>           <span class="n">seisflows_postprocess</span><span class="o">.</span><span class="n">p</span>  <span class="n">seisflows_system</span><span class="o">.</span><span class="n">p</span>
<span class="n">seisflows_parameters</span><span class="o">.</span><span class="n">json</span>  <span class="n">seisflows_preprocess</span><span class="o">.</span><span class="n">p</span>   <span class="n">seisflows_workflow</span><span class="o">.</span><span class="n">p</span>
<span class="n">seisflows_paths</span><span class="o">.</span><span class="n">json</span>           <span class="n">seisflows_solver</span><span class="o">.</span><span class="n">p</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># All of the parameters defined in parameters.yaml are saved in this</span>
<span class="c1"># internally-used JSON file</span>
<span class="o">!</span> head output/seisflows_parameters.json
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;ATTENUATION&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;BACKPROJECT&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;BEGIN&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;CASE&quot;</span><span class="p">:</span> <span class="s2">&quot;synthetic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COMPONENTS&quot;</span><span class="p">:</span> <span class="s2">&quot;ZNE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DENSITY&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DT&quot;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span>
    <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;F0&quot;</span><span class="p">:</span> <span class="mf">0.084</span><span class="p">,</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Similarly, paths that SeisFlows3 uses to navigate the system are stored</span>
<span class="c1"># in the seisflows_paths.json file</span>
<span class="o">!</span> head output/seisflows_paths.json
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;FUNC&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/scratch/scratch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GRAD&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/scratch/evalgrad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HESS&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/scratch/evalhess&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LOCAL&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;LOGFILE&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/output_sf3.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MASK&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;MODEL_INIT&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/specfem2d_workdir/OUTPUT_FILES_INIT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MODEL_TRUE&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/bchow/Work/work/sf3_specfem2d_example/specfem2d_workdir/OUTPUT_FILES_TRUE&quot;</span><span class="p">,</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-seisflows3">
<h3>3. Run SeisFlows3<a class="headerlink" href="#run-seisflows3" title="Permalink to this headline"></a></h3>
<p>In this Section we will run SeisFlows3 to generate synthetic
seismograms, kernels, a gradient, and an updated velocity model.</p>
<div class="section" id="a-forward-simulations">
<h4>3a. Forward simulations<a class="headerlink" href="#a-forward-simulations" title="Permalink to this headline"></a></h4>
<p>SeisFlows3 is an automated workflow tool, such that once we run
<code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">submit</span></code> we should not need to intervene in the workflow.
However the package does allow the User flexibility in how they want the
workflow to behave.</p>
<p>For example, we can run our workflow in stages by taking advantage of
the <code class="docutils literal notranslate"><span class="pre">stop_after</span></code> and <code class="docutils literal notranslate"><span class="pre">resume_from</span></code> parameters. As their names
suggest, these parameters allow us to stop and resume the workflow at
certain stages (i.e., functions in workflow.main()).</p>
<p>The available arguments for <code class="docutils literal notranslate"><span class="pre">stop_after</span></code> and <code class="docutils literal notranslate"><span class="pre">resume_from</span></code> are
discovered by running the command: <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">print</span> <span class="pre">flow</span></code>, which tells
us what functions will be run from main().</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows print flow
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                            SEISFLOWS3 WORKFLOW MAIN
                            ////////////////////////
Flow arguments for &lt;class &#39;seisflows3.workflow.inversion.Inversion&#39;&gt;

1: setup
2: initialize
3: evaluate_gradient
4: write_gradient
5: compute_direction
6: line_search
7: finalize
8: clean
</pre></div>
</div>
<hr class="docutils" />
<p>In an inversion (the workflow we have selected) the flow arguments are
described as:</p>
<ol class="arabic simple" start="0">
<li><p><strong>setup:</strong> Not technically listed in the flow arguments, runs setup()
for all SeisFlows3 modules. If running a synthetic-synthetic
workflow, solver.setup() will generate “data” by running the forward
solver using MODEL_TRUE</p></li>
<li><p><strong>initialize:</strong></p>
<ol class="loweralpha simple">
<li><p>Call numerical solver to run forward simulations using MODEL_INIT,
generating synthetics</p></li>
<li><p>Evaluate the objective function by performing waveform comparisons</p></li>
<li><p>Prepare <code class="docutils literal notranslate"><span class="pre">evaluate</span> <span class="pre">gradient</span></code> step by generating adjoint sources
and auxiliary files</p></li>
</ol>
</li>
<li><p><strong>evaluate_gradient:</strong> Call numerical solver to run adjoint
simulation, generating kernels</p></li>
<li><p><strong>write_gradient:</strong> Combine all event kernels into a misfit kernel.
Optionally smooth and mask the misfit kernel</p></li>
<li><p><strong>compute_direction:</strong> Call on the optimization library to scale the
misfit kernel into the gradient and compute a search direction</p></li>
<li><p><strong>line_search:</strong> Perform a line search by algorithmically scaling the
gradient and evaluating the misfit function (forward simulations and
misfit quantification) until misfit is acceptably reduced</p></li>
<li><p><strong>finalize:</strong> Run any finalization steps such as saving traces,
kernels, gradients and models to disk, setting up SeisFlows3 for any
subsequent iterations.</p></li>
<li><p><strong>clean:</strong> Clean the scratch/ directory in preparation for subsequent
i</p></li>
</ol>
<p>Let’s set the <code class="docutils literal notranslate"><span class="pre">stop_after</span></code> argument to <strong>initialize</strong>, this will halt
the workflow after the intialization step. We’ll also set the
<code class="docutils literal notranslate"><span class="pre">verbose</span></code> parameter to ‘False’, to keep the logging format relatively
simple. We will explore the <code class="docutils literal notranslate"><span class="pre">verbose</span></code>==True option in a later cell.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows par stop_after initialize
<span class="o">!</span> seisflows par verbose False
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">STOP_AFTER</span><span class="p">:</span>  <span class="o">-&gt;</span> <span class="n">initialize</span>
<span class="n">VERBOSE</span><span class="p">:</span> <span class="kc">False</span> <span class="o">-&gt;</span> <span class="kc">False</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Now let’s run SeisFlows3. There are a few ways to do this: <code class="docutils literal notranslate"><span class="pre">submit</span></code>,
<code class="docutils literal notranslate"><span class="pre">resume</span></code>, and <code class="docutils literal notranslate"><span class="pre">restart</span></code></p>
<ol class="arabic simple">
<li><p>Since we already ran <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">init</span></code>, the <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">submit</span></code>
option will not work, as SeisFlows3 considers this an active working
state and <code class="docutils literal notranslate"><span class="pre">submit</span></code> can only be run on uninitialized working states.</p></li>
<li><p>To run a workflow in an active working state <code class="docutils literal notranslate"><span class="pre">resume</span></code> will load the
current working state from the output/ directory and submit a
workflow given the current parameter file.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">restart</span></code> command is simply a convenience function that runs
<code class="docutils literal notranslate"><span class="pre">clean</span></code> (to remove an active working state) and <code class="docutils literal notranslate"><span class="pre">submit</span></code> (to
submit a fresh working state).</p></li>
</ol>
<p>Since we haven’t done anything in this working state, we will go with a
modified version of Option 3 by running <code class="docutils literal notranslate"><span class="pre">clean</span></code> and then <code class="docutils literal notranslate"><span class="pre">submit</span></code>.
We’ll use the <code class="docutils literal notranslate"><span class="pre">-f</span></code> flag (stands for <strong>‘force’</strong>) to skip over the
standard input prompt that asks the User if they are sure they want to
clean and submit.</p>
<p>But first we’ll try to run <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">submit</span></code> to show why Option 1
<strong>will not work</strong>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows submit -f
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">17</span> <span class="o">|</span> <span class="n">initializing</span> <span class="n">SeisFlows3</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
<span class="o">================================================================================</span>
                                    <span class="n">WARNING</span>
                                    <span class="o">///////</span>
<span class="n">Data</span> <span class="kn">from</span> <span class="nn">previous</span> <span class="n">workflow</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">working</span> <span class="n">directory</span><span class="o">.</span>

<span class="o">&gt;</span> <span class="n">seisflows</span> <span class="n">restart</span><span class="p">:</span> <span class="n">delete</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">start</span> <span class="n">new</span> <span class="n">workflow</span>
<span class="o">&gt;</span> <span class="n">seisflows</span> <span class="n">resume</span><span class="p">:</span> <span class="n">resume</span> <span class="n">existing</span> <span class="n">workflow</span>
<span class="o">================================================================================</span>
</pre></div>
</div>
<hr class="docutils" />
<p><strong>Okay, let’s go!</strong> In the following cell we will run the SeisFlows3
Inversion workflow. In the output cell we will see the logging
statements outputted by SeisFlows3, both to stdout and to the output log
file (defaults to ./output_seisflows3.txt) which details the progress of
our inversion</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows clean -f
<span class="o">!</span> seisflows submit -f
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">================================================================================</span>
                                     <span class="n">CLEAN</span>
                                     <span class="o">/////</span>
<span class="o">+</span> <span class="n">skipping</span> <span class="n">over</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">parameters</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">-</span> <span class="n">deleting</span> <span class="n">file</span><span class="o">/</span><span class="n">folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span>
<span class="o">-</span> <span class="n">deleting</span> <span class="n">file</span><span class="o">/</span><span class="n">folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">stats</span>
<span class="o">-</span> <span class="n">deleting</span> <span class="n">file</span><span class="o">/</span><span class="n">folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">output</span>
<span class="o">-</span> <span class="n">deleting</span> <span class="n">file</span><span class="o">/</span><span class="n">folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">output_sf3</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span> <span class="n">deleting</span> <span class="n">file</span><span class="o">/</span><span class="n">folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">37</span> <span class="o">|</span> <span class="n">initializing</span> <span class="n">SeisFlows3</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">output_sf3_001</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">parameters_001</span><span class="o">.</span><span class="n">yaml</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                  <span class="n">WORKFLOW</span> <span class="n">WILL</span> <span class="n">STOP</span> <span class="n">AFTER</span> <span class="n">FUNC</span><span class="p">:</span> <span class="s1">&#39;initialize&#39;</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">STARTING</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                                <span class="n">ITERATION</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                            <span class="n">PERFORMING</span> <span class="n">MODULE</span> <span class="n">SETUP</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">misfit</span> <span class="n">function</span> <span class="ow">is</span><span class="p">:</span> <span class="s1">&#39;waveform&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">43</span> <span class="o">|</span> <span class="n">writing</span> <span class="n">line</span> <span class="n">search</span> <span class="n">history</span> <span class="n">file</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">stats</span><span class="o">/</span><span class="n">line_search</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="n">checking</span> <span class="n">poissons</span> <span class="n">ratio</span> <span class="k">for</span><span class="p">:</span> <span class="s1">&#39;m_new.npy&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="n">model</span> <span class="n">parameters</span> <span class="p">(</span><span class="n">m_new</span><span class="o">.</span><span class="n">npy</span> <span class="n">i01s00</span><span class="p">):</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="mf">5800.00</span> <span class="o">&lt;=</span> <span class="n">vp</span> <span class="o">&lt;=</span> <span class="mf">5800.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="mf">3500.00</span> <span class="o">&lt;=</span> <span class="n">vs</span> <span class="o">&lt;=</span> <span class="mf">3500.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="mf">0.21</span> <span class="o">&lt;=</span> <span class="n">pr</span> <span class="o">&lt;=</span> <span class="mf">0.21</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span> <span class="o">|</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">solver</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">47</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">solver</span><span class="o">.</span><span class="n">setup</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span> <span class="n">initializing</span> <span class="mi">1</span> <span class="n">solver</span> <span class="n">directories</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">53</span> <span class="o">|</span> <span class="n">source</span> <span class="mi">001</span> <span class="n">symlinked</span> <span class="k">as</span> <span class="n">mainsolver</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">53</span> <span class="o">|</span> <span class="n">generating</span> <span class="s1">&#39;data&#39;</span> <span class="k">with</span> <span class="n">MODEL_TRUE</span> <span class="n">synthetics</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">running</span> <span class="n">mesh</span> <span class="n">generation</span> <span class="k">for</span> <span class="n">MODEL_INIT</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                             <span class="n">INITIALIZING</span> <span class="n">INVERSION</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">OBJECTIVE</span> <span class="n">FUNCTION</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">model</span> <span class="s1">&#39;m_new.npy&#39;</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">evalgrad</span><span class="o">/</span><span class="n">model</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">03</span> <span class="o">|</span> <span class="n">evaluating</span> <span class="n">objective</span> <span class="n">function</span> <span class="mi">1</span> <span class="n">times</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">03</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">solver</span><span class="o">.</span><span class="n">eval_func</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span> <span class="n">running</span> <span class="n">forward</span> <span class="n">simulations</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span> <span class="n">calling</span> <span class="n">preprocess</span><span class="o">.</span><span class="n">prepare_eval_grad</span><span class="p">()</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span> <span class="n">preparing</span> <span class="n">files</span> <span class="k">for</span> <span class="n">gradient</span> <span class="n">evaluation</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">residuals</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">evalgrad</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span> <span class="n">summing</span> <span class="n">residuals</span> <span class="k">with</span> <span class="n">preprocess</span> <span class="n">module</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">misfit</span> <span class="mf">1.748E-03</span> <span class="n">to</span> <span class="n">tag</span> <span class="s1">&#39;f_new.txt&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                            <span class="n">FINISHED</span> <span class="n">FLOW</span> <span class="n">EXECUTION</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">FINISHED</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a detailed exploration of a SeisFlows3 working directory, see the <a class="reference external" href="working_directory.html">working directory</a> documentation page where we explain each of the files and directories that have been generated during this workflow. Below we just look at two files which are required for our adjoint simulation, the adjoint sources (.adj) and STATIONS_ADJOINT file</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The adjoint source is created in the same format as the synthetics (two-column ASCII)</span>
<span class="o">!</span> head scratch/solver/001/traces/adj/AA.S0001.BXY.adj
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mf">48.0000000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.9400000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.8800000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.8200000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.7600000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.7000000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.6400000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.5800000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.5200000</span>         <span class="mf">0.0000000</span>
<span class="o">-</span><span class="mf">47.4600000</span>         <span class="mf">0.0000000</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can also see that we have generated a STATIONS_ADJOINT file, which is required for</span>
<span class="c1"># running the adjoint simulations (i.e., evaluate the gradient)</span>
<span class="o">!</span> head scratch/solver/001/DATA/STATIONS_ADJOINT
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">S0001</span>    <span class="n">AA</span>       <span class="mf">180081.4100000</span>       <span class="mf">388768.7100000</span>       <span class="mf">0.0</span>         <span class="mf">0.0</span>
</pre></div>
</div>
</div>
<div class="section" id="b-adjoint-simulations">
<h4>3b. Adjoint simulations<a class="headerlink" href="#b-adjoint-simulations" title="Permalink to this headline"></a></h4>
<p>Now that we have all the required files for running an adjoint
simulation (<a href="#id13"><span class="problematic" id="id14">*</span></a>.adj waveforms and STATIONS_ADJOINT file), we can continue
with the SeisFlows3 Inversion workflow. No need to edit the Par_file or
anything like that, SeisFlows3 will take care of that under the hood. We
simply need to tell the workflow (via the parameters.yaml file) to
<code class="docutils literal notranslate"><span class="pre">resume_from</span></code> the correct function. We can have a look at these
functions again:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows print flow
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                            SEISFLOWS3 WORKFLOW MAIN
                            ////////////////////////
Flow arguments for &lt;class &#39;seisflows3.workflow.inversion.Inversion&#39;&gt;

1: setup
2: initialize
3: evaluate_gradient
4: write_gradient
5: compute_direction
6: line_search
7: finalize
8: clean
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll stop just before the line search so that we can take a look at the files</span>
<span class="c1"># generated during the middle tasks</span>
<span class="o">!</span> seisflows par resume_from evaluate_gradient
<span class="o">!</span> seisflows par stop_after compute_direction
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RESUME_FROM</span><span class="p">:</span>  <span class="o">-&gt;</span> <span class="n">evaluate_gradient</span>
<span class="n">STOP_AFTER</span><span class="p">:</span> <span class="n">initialize</span> <span class="o">-&gt;</span> <span class="n">compute_direction</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can use the `seisflows resume` command to continue an active workflow</span>
<span class="c1"># again we use the &#39;-f&#39; flag to skip past the user-input stage.</span>
<span class="o">!</span> seisflows resume -f
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">output_sf3_002</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">parameters_002</span><span class="o">.</span><span class="n">yaml</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
              <span class="n">WORKFLOW</span> <span class="n">WILL</span> <span class="n">RESUME</span> <span class="n">FROM</span> <span class="n">FUNC</span><span class="p">:</span> <span class="s1">&#39;evaluate_gradient&#39;</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
               <span class="n">WORKFLOW</span> <span class="n">WILL</span> <span class="n">STOP</span> <span class="n">AFTER</span> <span class="n">FUNC</span><span class="p">:</span> <span class="s1">&#39;compute_direction&#39;</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">STARTING</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                                <span class="n">ITERATION</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                              <span class="n">EVALUATING</span> <span class="n">GRADIENT</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span> <span class="n">evaluating</span> <span class="n">gradient</span> <span class="mi">1</span> <span class="n">times</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">22</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">23</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">solver</span><span class="o">.</span><span class="n">eval_grad</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">23</span> <span class="o">|</span> <span class="n">running</span> <span class="n">adjoint</span> <span class="n">simulations</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">38</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">kernels</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">evalgrad</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">38</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                             <span class="n">POSTPROCESSING</span> <span class="n">KERNELS</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">38</span> <span class="o">|</span> <span class="n">processing</span> <span class="n">kernels</span> <span class="n">into</span> <span class="n">gradient</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">38</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">39</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">39</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">postprocess</span><span class="o">.</span><span class="n">process_kernels</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">39</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">summed</span> <span class="n">kernels</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">evalgrad</span><span class="o">/</span><span class="n">kernels</span><span class="o">/</span><span class="nb">sum</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                           <span class="n">COMPUTING</span> <span class="n">SEARCH</span> <span class="n">DIRECTION</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span> <span class="o">|</span> <span class="n">computing</span> <span class="n">search</span> <span class="n">direction</span> <span class="k">with</span> <span class="n">L</span><span class="o">-</span><span class="n">BFGS</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span> <span class="o">|</span> <span class="n">first</span> <span class="n">L</span><span class="o">-</span><span class="n">BFGS</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">setting</span> <span class="n">search</span> <span class="n">direction</span> <span class="k">as</span> <span class="n">inverse</span> <span class="n">gradient</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                            <span class="n">FINISHED</span> <span class="n">FLOW</span> <span class="n">EXECUTION</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">FINISHED</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
</pre></div>
</div>
<hr class="docutils" />
<p>The functions <strong>evaluate_gradient()</strong> through <strong>compute_direction()</strong>
have run adjoint simulations to generate event kernels and sum the
kernels into the misfit kernel.</p>
<blockquote>
<div><p><strong>NOTE</strong>: Because we only have one event, our misfit kernel is just
exactly our event kernel. And since we did not specify any smoothing
lenghts (PAR.SMOOTH_H and PAR.SMOOTH_V), no smoothing of the gradient
has occurred.</p>
</div></blockquote>
<p>Using the L-BFGS optimization algorithm, SeisFlows3 has computed a
search direction that will be used in the line search to search for a
best fitting model which optimally reduces the objective function. We
can take a look at where SeisFlows3 has stored the information relating
to kernel generation and the optimization computation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gradient evaluation files are stored here, the kernels are stored separately from the gradient incase</span>
<span class="c1"># the user wants to manually manipulate them</span>
<span class="o">!</span> ls scratch/evalgrad
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradient</span>  <span class="n">kernels</span>  <span class="n">model</span>  <span class="n">residuals</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SeisFlows3 stores all kernels and gradient information as SPECFEM binary (.bin) files</span>
<span class="o">!</span> ls scratch/evalgrad/gradient
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proc000000_vp_kernel</span><span class="o">.</span><span class="n">bin</span>  <span class="n">proc000000_vs_kernel</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Kernels are stored on a per-event basis, and summed together (sum/). If smoothing was performed,</span>
<span class="c1"># we would see both smoothed and unsmoothed versions of the misfit kernel</span>
<span class="o">!</span> ls scratch/evalgrad/kernels
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">001</span>  <span class="nb">sum</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can see that some new values have been stored in prepartion for the line search,</span>
<span class="c1"># including g_new (current gradient) and p_new (current search direction). These are also</span>
<span class="c1"># stored as vector NumPy arrays (.npy files)</span>
<span class="o">!</span> ls scratch/optimize
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f_new</span><span class="o">.</span><span class="n">txt</span>  <span class="n">g_new</span><span class="o">.</span><span class="n">npy</span>  <span class="n">LBFGS</span>  <span class="n">m_new</span><span class="o">.</span><span class="n">npy</span>      <span class="n">p_new</span><span class="o">.</span><span class="n">npy</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;scratch/optimize/p_new.npy&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p_new</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">-</span><span class="mf">0.00000000e+00</span> <span class="o">-</span><span class="mf">0.00000000e+00</span> <span class="o">-</span><span class="mf">0.00000000e+00</span> <span class="o">...</span> <span class="o">-</span><span class="mf">3.96447909e-11</span>
 <span class="o">-</span><span class="mf">2.00156454e-11</span> <span class="o">-</span><span class="mf">2.61676726e-12</span><span class="p">]</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="c-line-search-and-model-update">
<h4>3c. Line search and model update<a class="headerlink" href="#c-line-search-and-model-update" title="Permalink to this headline"></a></h4>
<p>Let’s finish off the inversion by running through the line search, which
will generate new models using the gradient, evaluate the objective
function by running forward simulations, and comparing the evaluated
objective function with the value obtained in <strong>initialize</strong>.
Satisfactory reduction in the objective function will result in a
termination of the line search. We are using a bracketing line search
here (CITE RYANS PAPER), which requires finding models which both
increase and decrease the misfit with respect to the initial evaluation.
Therefore it will likely take more than two trial steps to complete the
line search</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>! seisflows par resume_from line_search  # resume from the line search
! seisflows par stop_after finalize  # We don&#39;t want to run the clean() argument so that we can explore the dir
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RESUME_FROM</span><span class="p">:</span> <span class="n">evaluate_gradient</span> <span class="o">-&gt;</span> <span class="n">line_search</span>
<span class="n">STOP_AFTER</span><span class="p">:</span> <span class="n">compute_direction</span> <span class="o">-&gt;</span> <span class="n">finalize</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> seisflows resume -f
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">40</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">output_sf3_003</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">40</span> <span class="o">|</span> <span class="n">copying</span> <span class="n">par</span><span class="o">/</span><span class="n">log</span> <span class="n">file</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">parameters_003</span><span class="o">.</span><span class="n">yaml</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">40</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                 <span class="n">WORKFLOW</span> <span class="n">WILL</span> <span class="n">RESUME</span> <span class="n">FROM</span> <span class="n">FUNC</span><span class="p">:</span> <span class="s1">&#39;line_search&#39;</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                   <span class="n">WORKFLOW</span> <span class="n">WILL</span> <span class="n">STOP</span> <span class="n">AFTER</span> <span class="n">FUNC</span><span class="p">:</span> <span class="s1">&#39;finalize&#39;</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">STARTING</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                                <span class="n">ITERATION</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                        <span class="n">CONDUCTING</span> <span class="n">LINE</span> <span class="n">SEARCH</span> <span class="p">(</span><span class="n">i01s00</span><span class="p">)</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="nb">max</span> <span class="n">step</span> <span class="n">length</span> <span class="n">safeguard</span> <span class="ow">is</span><span class="p">:</span> <span class="mf">5.26E+10</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">BRACKETING</span> <span class="n">LINE</span> <span class="n">SEARCH</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">step</span> <span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.00E+00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">misfit</span> <span class="n">val</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="o">=</span> <span class="mf">1.75E-03</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">first</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">guessing</span> <span class="n">trial</span> <span class="n">step</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">initial</span> <span class="n">step</span> <span class="n">length</span> <span class="n">safegaurd</span><span class="p">,</span> <span class="n">setting</span> <span class="n">manual</span> <span class="n">step</span> <span class="n">length</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">manually</span> <span class="nb">set</span> <span class="n">initial</span> <span class="n">step</span> <span class="n">length</span><span class="p">:</span> <span class="mf">5.26E+09</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">checking</span> <span class="n">poissons</span> <span class="n">ratio</span> <span class="k">for</span><span class="p">:</span> <span class="s1">&#39;m_try.npy&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">model</span> <span class="n">parameters</span> <span class="p">(</span><span class="n">m_try</span><span class="o">.</span><span class="n">npy</span> <span class="n">i01s00</span><span class="p">):</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="mf">5800.00</span> <span class="o">&lt;=</span> <span class="n">vp</span> <span class="o">&lt;=</span> <span class="mf">5800.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="mf">3278.69</span> <span class="o">&lt;=</span> <span class="n">vs</span> <span class="o">&lt;=</span> <span class="mf">3790.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="mf">0.13</span> <span class="o">&lt;=</span> <span class="n">pr</span> <span class="o">&lt;=</span> <span class="mf">0.27</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                            <span class="n">TRIAL</span> <span class="n">STEP</span> <span class="n">COUNT</span><span class="p">:</span> <span class="n">i01s01</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">OBJECTIVE</span> <span class="n">FUNCTION</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">model</span> <span class="s1">&#39;m_try.npy&#39;</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">model</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">evaluating</span> <span class="n">objective</span> <span class="n">function</span> <span class="mi">1</span> <span class="n">times</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">solver</span><span class="o">.</span><span class="n">eval_func</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span> <span class="n">running</span> <span class="n">forward</span> <span class="n">simulations</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">49</span> <span class="o">|</span> <span class="n">calling</span> <span class="n">preprocess</span><span class="o">.</span><span class="n">prepare_eval_grad</span><span class="p">()</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">49</span> <span class="o">|</span> <span class="n">preparing</span> <span class="n">files</span> <span class="k">for</span> <span class="n">gradient</span> <span class="n">evaluation</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">residuals</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">scratch</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">summing</span> <span class="n">residuals</span> <span class="k">with</span> <span class="n">preprocess</span> <span class="n">module</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">misfit</span> <span class="mf">9.850E-04</span> <span class="n">to</span> <span class="n">tag</span> <span class="s1">&#39;f_try.txt&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">BRACKETING</span> <span class="n">LINE</span> <span class="n">SEARCH</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">step</span> <span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.00E+00</span><span class="p">,</span> <span class="mf">5.26E+09</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">misfit</span> <span class="n">val</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="o">=</span> <span class="mf">1.75E-03</span><span class="p">,</span> <span class="mf">9.85E-04</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">misfit</span> <span class="ow">not</span> <span class="n">bracketed</span><span class="p">,</span> <span class="n">increasing</span> <span class="n">step</span> <span class="n">length</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">checking</span> <span class="n">poissons</span> <span class="n">ratio</span> <span class="k">for</span><span class="p">:</span> <span class="s1">&#39;m_try.npy&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">model</span> <span class="n">parameters</span> <span class="p">(</span><span class="n">m_try</span><span class="o">.</span><span class="n">npy</span> <span class="n">i01s01</span><span class="p">):</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="mf">5800.00</span> <span class="o">&lt;=</span> <span class="n">vp</span> <span class="o">&lt;=</span> <span class="mf">5800.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="mf">3141.92</span> <span class="o">&lt;=</span> <span class="n">vs</span> <span class="o">&lt;=</span> <span class="mf">3969.23</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="mf">0.06</span> <span class="o">&lt;=</span> <span class="n">pr</span> <span class="o">&lt;=</span> <span class="mf">0.29</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">retrying</span> <span class="k">with</span> <span class="n">new</span> <span class="n">trial</span> <span class="n">step</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
                            <span class="n">TRIAL</span> <span class="n">STEP</span> <span class="n">COUNT</span><span class="p">:</span> <span class="n">i01s02</span>
<span class="o">////////////////////////////////////////////////////////////////////////////////</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">OBJECTIVE</span> <span class="n">FUNCTION</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">50</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">model</span> <span class="s1">&#39;m_try.npy&#39;</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">model</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">51</span> <span class="o">|</span> <span class="n">evaluating</span> <span class="n">objective</span> <span class="n">function</span> <span class="mi">1</span> <span class="n">times</span> <span class="n">on</span> <span class="n">system</span><span class="o">...</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">51</span> <span class="o">|</span> <span class="n">checkpointing</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">52</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">53</span> <span class="o">|</span> <span class="n">running</span> <span class="n">task</span> <span class="n">solver</span><span class="o">.</span><span class="n">eval_func</span> <span class="mi">1</span> <span class="n">times</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">53</span> <span class="o">|</span> <span class="n">running</span> <span class="n">forward</span> <span class="n">simulations</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">59</span> <span class="o">|</span> <span class="n">calling</span> <span class="n">preprocess</span><span class="o">.</span><span class="n">prepare_eval_grad</span><span class="p">()</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">59</span> <span class="o">|</span> <span class="n">preparing</span> <span class="n">files</span> <span class="k">for</span> <span class="n">gradient</span> <span class="n">evaluation</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">59</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">residuals</span> <span class="n">to</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">scratch</span><span class="o">/</span><span class="n">scratch</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">summing</span> <span class="n">residuals</span> <span class="k">with</span> <span class="n">preprocess</span> <span class="n">module</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">misfit</span> <span class="mf">1.227E-03</span> <span class="n">to</span> <span class="n">tag</span> <span class="s1">&#39;f_try.txt&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>
<span class="n">EVALUATE</span> <span class="n">BRACKETING</span> <span class="n">LINE</span> <span class="n">SEARCH</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">step</span> <span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.00E+00</span><span class="p">,</span> <span class="mf">5.26E+09</span><span class="p">,</span> <span class="mf">8.51E+09</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">misfit</span> <span class="n">val</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="o">=</span> <span class="mf">1.75E-03</span><span class="p">,</span> <span class="mf">9.85E-04</span><span class="p">,</span> <span class="mf">1.23E-03</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">bracket</span> <span class="n">okay</span><span class="p">,</span> <span class="n">step</span> <span class="n">length</span> <span class="n">reasonable</span><span class="p">,</span> <span class="k">pass</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">checking</span> <span class="n">poissons</span> <span class="n">ratio</span> <span class="k">for</span><span class="p">:</span> <span class="s1">&#39;m_try.npy&#39;</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">model</span> <span class="n">parameters</span> <span class="p">(</span><span class="n">m_try</span><span class="o">.</span><span class="n">npy</span> <span class="n">i01s02</span><span class="p">):</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="mf">5800.00</span> <span class="o">&lt;=</span> <span class="n">vp</span> <span class="o">&lt;=</span> <span class="mf">5800.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="mf">3278.69</span> <span class="o">&lt;=</span> <span class="n">vs</span> <span class="o">&lt;=</span> <span class="mf">3790.00</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="mf">0.13</span> <span class="o">&lt;=</span> <span class="n">pr</span> <span class="o">&lt;=</span> <span class="mf">0.27</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">trial</span> <span class="n">step</span> <span class="n">successful</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>
<span class="n">FINALIZING</span> <span class="n">LINE</span> <span class="n">SEARCH</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">shifting</span> <span class="n">current</span> <span class="n">model</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">model</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">setting</span> <span class="n">accepted</span> <span class="n">line</span> <span class="n">search</span> <span class="n">model</span> <span class="k">as</span> <span class="n">current</span> <span class="n">model</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">current</span> <span class="n">misfit</span> <span class="ow">is</span> <span class="n">f_new</span><span class="o">.</span><span class="n">txt</span><span class="o">=</span><span class="mf">9.850E-04</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">writing</span> <span class="n">optimization</span> <span class="n">stats</span> <span class="n">to</span><span class="p">:</span> <span class="n">stats</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">resetting</span> <span class="n">line</span> <span class="n">search</span> <span class="n">step</span> <span class="n">count</span> <span class="n">to</span> <span class="mi">0</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                             <span class="n">FINALIZING</span> <span class="n">ITERATION</span> <span class="mi">1</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">exporting</span> <span class="n">current</span> <span class="n">working</span> <span class="n">environment</span> <span class="n">to</span> <span class="n">disk</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">01</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">model</span> <span class="s1">&#39;m_new.npy&#39;</span> <span class="n">to</span> <span class="n">path</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">model_0001</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span> <span class="n">saving</span> <span class="n">gradient</span> <span class="n">to</span> <span class="n">path</span><span class="p">:</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bchow</span><span class="o">/</span><span class="n">Work</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">sf3_specfem2d_example</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">gradient_0001</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                            <span class="n">FINISHED</span> <span class="n">FLOW</span> <span class="n">EXECUTION</span>
<span class="o">================================================================================</span>
<span class="mi">2022</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">================================================================================</span>
                          <span class="n">FINISHED</span> <span class="n">INVERSION</span> <span class="n">WORKFLOW</span>
<span class="o">================================================================================</span>
</pre></div>
</div>
<p>From the log statements above, we can see that the SeisFlows3 line
search required 2 trial steps, where it modified values of Vs until
satisfactory reduction in the objective function was met. This was the
final step in the iteration, and so the finalization step made
last-minute preparations for a subsequent iteration.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can see that we have &#39;new&#39; and &#39;old&#39; values for each of the optimization values,</span>
<span class="c1"># representing the previous model (M00) and the current model (M01).</span>
<span class="o">!</span> ls scratch/optimize
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span><span class="o">.</span><span class="n">npy</span>  <span class="n">f_old</span><span class="o">.</span><span class="n">txt</span>  <span class="n">g_old</span><span class="o">.</span><span class="n">npy</span>  <span class="n">m_new</span><span class="o">.</span><span class="n">npy</span>  <span class="n">p_old</span><span class="o">.</span><span class="n">npy</span>
<span class="n">f_new</span><span class="o">.</span><span class="n">txt</span>  <span class="n">f_try</span><span class="o">.</span><span class="n">txt</span>  <span class="n">LBFGS</span>  <span class="n">m_old</span><span class="o">.</span><span class="n">npy</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The stats/ directory contains text files describing the optimization/line search</span>
<span class="o">!</span> ls stats
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">factor</span><span class="o">.</span><span class="n">txt</span>        <span class="n">line_search</span><span class="o">.</span><span class="n">txt</span>  <span class="n">slope</span><span class="o">.</span><span class="n">txt</span>        <span class="n">theta</span><span class="o">.</span><span class="n">txt</span>
<span class="n">gradient_norm_L1</span><span class="o">.</span><span class="n">txt</span>  <span class="n">misfit</span><span class="o">.</span><span class="n">txt</span>       <span class="n">step_count</span><span class="o">.</span><span class="n">txt</span>
<span class="n">gradient_norm_L2</span><span class="o">.</span><span class="n">txt</span>  <span class="n">restarted</span><span class="o">.</span><span class="n">txt</span>    <span class="n">step_length</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For example we can look at the step length chosen for the accepted trial step in the line search</span>
<span class="o">!</span> cat stats/line_search.txt
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">ITER</span>     <span class="n">STEPLEN</span>      <span class="n">MISFIT</span>
<span class="o">==========</span>  <span class="o">==========</span>  <span class="o">==========</span>
         <span class="mi">1</span>   <span class="mf">0.000e+00</span>   <span class="mf">1.748e-03</span>
             <span class="mf">5.261e+09</span>   <span class="mf">9.850e-04</span>
             <span class="mf">8.512e+09</span>   <span class="mf">1.227e-03</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="conclusions">
<h3>4. Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline"></a></h3>
<p>We’ve now seen how SeisFlows3 runs an <strong>Inversion</strong> workflow using the
<strong>Specfem2D</strong> solver on a <strong>serial</strong> system (local workstation). More or
less, this is all you need to run SeisFlows3 with any combination of
modules. The specificities of a system or numerical solver are already
handled internally by SeisFlows3, so if you want to use
Specmfe3D_Cartesian as your solver, you would only need to run
<code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">par</span> <span class="pre">solver</span> <span class="pre">specfem3d</span></code> at the beginning of your workflow
(you will also need to setup your Specfem3D models, similar to what we
did for Specfem2D here). To run on a slurm system like Chinook, you can
run <code class="docutils literal notranslate"><span class="pre">seisflows</span> <span class="pre">par</span> <span class="pre">system</span> <span class="pre">chinook</span></code>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="working_directory.html" class="btn btn-neutral float-left" title="Working Directory Structure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="extending.html" class="btn btn-neutral float-right" title="Extending SeisFlows3" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, SeisFlows3 Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>