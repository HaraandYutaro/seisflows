# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
#                 Seisflows YAML Parameter File and Path Input
#
#  For NoneType, set variables to `None` or `null`. For infinity, set to `inf`
#
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
# These modules correspond to the structure of the source code, and determine
# SeisFlows' behavior at runtime. Check the source code directory for available 
# module names. Each module will require its own set of sub parameters. 
#
# To fill this parameter file with docstrings and default values, run:
#
# > seisflows configure
#
#                                    MODULES
#                                    -------
#
# WORKFLOW:    The method for running SeisFlows. Equivalent to main()
# SOLVER:      External numerical solver to use for waveform simulations.
# SYSTEM:      Computer architecture of the system being used to run SeisFlows
# OPTIMIZE:    Optimization algorithm for the inverse problem
# PREPROCESS:  Preprocessing schema for waveform data
# POSTPROCESS: Postprocessing schema for kernels and gradients
#
# ==============================================================================
WORKFLOW: inversion
SOLVER: specfem3d
SYSTEM: serial
OPTIMIZE: LBFGS 
PREPROCESS: default
POSTPROCESS: base

# ==============================================================================
#
#                                     SYSTEM                                    
#                                     ------                                    
#
# TITLE (str):
#    The name used to submit jobs to the system, defaults to the name of the
#    working directory
# WALLTIME (float):
#    Maximum job time in minutes for main SeisFlows job
# TASKTIME (float):
#    Maximum job time in minutes for each SeisFlows task
# NTASK (int):
#    Number of separate, individual tasks. Also equal to the number of desired
#    sources in workflow
# NPROC (int):
#    Number of processor to use for each simulation
# PRECHECK (list):
#    A list of parameters that will be displayed to stdout before 'submit' or
#    'resume' is run. Useful for manually reviewing important parameters prior
#    to system submission
# MPIEXEC (str):
#    Function used to invoke parallel executables

# ==============================================================================
TITLE: test_data
WALLTIME: !!! REQUIRED PARAMETER !!!
TASKTIME: !!! REQUIRED PARAMETER !!!
NTASK: 1
NPROC: 1
PRECHECK:
    - TITLE
    - BEGIN
    - END
    - WALLTIME
MPIEXEC:

# ==============================================================================
#
#                                   PREPROCESS                                  
#                                   ----------                                  
#
# MISFIT (str):
#    Misfit function for waveform comparisons, for available see
#    seisflows.plugins.misfit
# BACKPROJECT (str):
#    Backprojection function for migration, for available see
#    seisflows.plugins.adjoint
# NORMALIZE (str):
#    Data normalization option
# MUTE (str):
#    Data muting option
# FILTER (str):
#    Data filtering option

# ==============================================================================
MISFIT: null
BACKPROJECT: null
NORMALIZE: null
MUTE: null
FILTER: null

# ==============================================================================
#
#                                     SOLVER                                    
#                                     ------                                    
#
# MATERIALS (str):
#    Material parameters used to define model. Available: ['ELASTIC': Vp, Vs,
#    'ACOUSTIC': Vp, 'ISOTROPIC', 'ANISOTROPIC']
# DENSITY (str):
#    How to treat density during inversion. Available: ['CONSTANT': Do not
#    update density, 'VARIABLE': Update density]
# COMPONENTS (str):
#    Components used to generate data, formatted as a single string, e.g. ZNE
#    or NZ or E
# SOLVERIO (int):
#    The format external solver files. Available: ['fortran_binary', 'adios']
# NT (float):
#    Number of time steps set in the SPECFEM Par_file
# DT (float):
#    Time step or delta set in the SPECFEM Par_file
# FORMAT (float):
#    Format of synthetic waveforms used during workflow, available options:
#    ['ascii', 'su']
# SOURCE_PREFIX (str):
#    Prefix of SOURCE files in path SPECFEM_DATA. Available ['CMTSOLUTION',
#    FORCESOLUTION']

# ==============================================================================
MATERIALS: !!! REQUIRED PARAMETER !!!
DENSITY: !!! REQUIRED PARAMETER !!!
COMPONENTS: ZNE
SOLVERIO: fortran_binary
NT: !!! REQUIRED PARAMETER !!!
DT: !!! REQUIRED PARAMETER !!!
FORMAT: !!! REQUIRED PARAMETER !!!
SOURCE_PREFIX: CMTSOLUTION

# ==============================================================================
#
#                                  POSTPROCESS                                  
#                                  -----------                                  
#
# SMOOTH_H (float):
#    Gaussian half-width for horizontal smoothing in units of meters. If 0.,
#    no smoothing applied
# SMOOTH_V (float):
#    Gaussian half-width for vertical smoothing in units of meters
# TASKTIME_SMOOTH (int):
#    Large radii smoothing may take longer than normal tasks. Allocate
#    additional smoothing task time as a multiple of TASKTIME

# ==============================================================================
SMOOTH_H: 0.0
SMOOTH_V: 0.0
TASKTIME_SMOOTH: 1

# ==============================================================================
#
#                                    OPTIMIZE                                   
#                                    --------                                   
#
# LINESEARCH (str):
#    Algorithm to use for line search, see seisflows.plugins.line_search for
#    available choices
# PRECOND (str):
#    Algorithm to use for preconditioning gradients, see
#    seisflows.plugins.preconds for available choices
# STEPCOUNTMAX (int):
#    Max number of trial steps in line search before a change in line serach
#    behavior
# STEPLENINIT (float):
#    Initial line serach step length, as a fraction of current model
#    parameters
# STEPLENMAX (float):
#    Max allowable step length, as a fraction of current model parameters
# LBFGSMEM (int):
#    Max number of previous gradients to retain in local memory
# LBFGSMAX (int):
#    LBFGS periodic restart interval, between 1 and 'inf'
# LBFGSTHRESH (float):
#    LBFGS angle restart threshold

# ==============================================================================
LINESEARCH: Backtrack
PRECOND:
STEPCOUNTMAX: 10
STEPLENINIT: 0.05
STEPLENMAX: 0.5
LBFGSMEM: 3
LBFGSMAX: inf
LBFGSTHRESH: 0.0

# ==============================================================================
#
#                                    WORKFLOW                                   
#                                    --------                                   
#
# BEGIN (int):
#    First iteration of workflow, 1 <= BEGIN <= inf
# END (int):
#    Last iteration of workflow, BEGIN <= END <= inf
# RESUME_FROM (str):
#    Name of task to resume inversion from
# STOP_AFTER (str):
#    Name of task to stop inversion after finishing
# CASE (str):
#    Type of inversion, available: ['data': real data inversion, 'synthetic':
#    synthetic-synthetic inversion]
# SAVEMODEL (bool):
#    Save final model files after each iteration
# SAVEGRADIENT (bool):
#    Save gradient files after each iteration
# SAVEKERNELS (bool):
#    Save event kernel files after each iteration
# SAVETRACES (bool):
#    Save waveform traces after each iteration
# SAVERESIDUALS (bool):
#    Save waveform residuals after each iteration
# SAVEAS (str):
#    Format to save models, gradients, kernels. Available: ['binary': save
#    files in native SPECFEM .bin format, 'vector': save files as NumPy .npy
#    files, 'both': save as both binary and vectors]
# VERBOSE (bool):
#    Provide detailed statements to the output logs

# ==============================================================================
BEGIN: !!! REQUIRED PARAMETER !!!
END: !!! REQUIRED PARAMETER !!!
RESUME_FROM:
STOP_AFTER:
CASE: !!! REQUIRED PARAMETER !!!
SAVEMODEL: True
SAVEGRADIENT: True
SAVEKERNELS: False
SAVETRACES: False
SAVERESIDUALS: False
SAVEAS: binary
VERBOSE: True

# ==============================================================================
#
#                                     PATHS                                     
#                                     -----                                     
#
# SCRATCH:
#    scratch path to hold temporary data during workflow
# OUTPUT:
#    directory to save workflow outputs to disk
# SYSTEM:
#    scratch path to hold any system related data
# LOCAL:
#    path to local data to be used during workflow
# SOLVER:
#    scratch path to hold solver working directories
# SPECFEM_BIN:
#    path to the SPECFEM binary executables
# SPECFEM_DATA:
#    path to the SPECFEM DATA/ directory containing the 'Par_file', 'STATIONS'
#    file and 'CMTSOLUTION' files
# MASK:
#    Directory to mask files for gradient masking
# OPTIMIZE:
#    scratch path to store data related to nonlinear optimization
# MODEL_INIT:
#    Initial model to be used for workflow
# MODEL_TRUE:
#    Target model to be used for PAR.CASE == 'synthetic'
# DATA:
#    path to data available to workflow
# FUNC:
#    scratch path to store data related to function evaluations
# GRAD:
#    scratch path to store data related to gradient evaluations
# HESS:
#    scratch path to store data related to Hessian evaluations

# ==============================================================================
PATHS:
    SCRATCH: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch
    OUTPUT: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/output
    SYSTEM: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/system
    LOCAL:
    SOLVER: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/solver
    SPECFEM_BIN: !!! REQUIRED PATH !!!
    SPECFEM_DATA: !!! REQUIRED PATH !!!
    MASK:
    OPTIMIZE: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/optimize
    MODEL_INIT: !!! REQUIRED PATH !!!
    MODEL_TRUE:
    DATA:
    FUNC: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/evalfunc
    GRAD: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/evalgrad
    HESS: /home/bchow/REPOSITORIES/seisflows3/seisflows3/tests/test_data/scratch/evalhess
